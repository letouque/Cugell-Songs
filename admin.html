<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cugell – Admin</title>

  <style>
    body{
      margin:0; padding:0;
      font-family: Trebuchet MS, Arial, sans-serif;
      background: radial-gradient(circle at top, #55415f 0, #1c1024 40%, #050308 100%);
      color:#f7f1e3;
    }
    .wrap{
      max-width:1300px; margin:24px auto; padding:18px;
      background:#3b2b22; border:2px solid #c79b53; border-radius:16px;
      box-shadow:0 0 25px rgba(0,0,0,.7);
    }
    .top{
      display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-bottom:14px;
    }
    .btn{
      background:#2b1d16; color:#f7f1e3;
      border:1px solid #c79b53; border-radius:10px;
      padding:10px 12px; cursor:pointer; font-size:14px;
    }
    .btn.primary{ background:#c79b53; color:#2b1d16; font-weight:bold; }
    .row{ display:flex; gap:14px; flex-wrap:wrap; }
    .card{
      background:#4a3427; border:1px solid #c79b53; border-radius:12px;
      padding:12px;
    }
    .left{ flex: 1 1 380px; min-width:320px; }
    .right{ flex: 2 1 700px; min-width:320px; }
    h1{ margin:0 0 8px 0; font-size:22px; }
    h2{ margin:0 0 10px 0; font-size:14px; font-weight:normal; color:#d3c2a5; }
    label{ font-size:12px; color:#e5d3b0; display:block; margin:10px 0 6px; }
    input, textarea{
      width:100%;
      background:#2b1d16; color:#f7f1e3;
      border:1px solid #c79b53; border-radius:10px;
      padding:10px; font-size:14px; box-sizing:border-box;
    }
    textarea{ min-height:84px; resize:vertical; }
    .list{
      margin-top:10px;
      max-height:520px; overflow:auto;
      border:1px solid #c79b53; border-radius:10px;
      background:#2b1d16;
    }
    .item{
      padding:10px; border-bottom:1px solid rgba(199,155,83,.35);
      cursor:pointer;
    }
    .item:hover{ background: rgba(199,155,83,.12); }
    .item.active{ background: rgba(199,155,83,.22); }
    .meta{ font-size:12px; color:#d3c2a5; margin-top:4px; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media(max-width:900px){ .grid2{ grid-template-columns:1fr; } }
    .coverBox{
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
      margin-top:10px;
    }
    .coverPreview{
      width:110px; height:110px; border-radius:12px;
      border:1px solid #c79b53; background:#2b1d16;
      overflow:hidden;
    }
    .coverPreview img{ width:100%; height:100%; object-fit:cover; }
    .hint{ font-size:12px; color:#d3c2a5; margin-top:8px; line-height:1.4; }
    .pillRow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .pill{
      border:1px solid #c79b53; background:#2b1d16; border-radius:999px;
      padding:6px 10px; font-size:12px; color:#f7f1e3;
    }
    .small{ font-size:12px; color:#d3c2a5; }
    .divider{ height:1px; background:rgba(199,155,83,.35); margin:14px 0; }

    /* checkbox pills */
    .pillRow label{
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      user-select:none;
    }
    .pillRow input[type="checkbox"]{
      width:auto;
      margin:0;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Cugell – Admin (Songs)</h1>
        <h2>Edit individually + bulk import CSV → Export ZIP</h2>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <label class="btn">
          Import songsX.js
          <input id="jsFile" type="file" accept=".js" style="display:none;">
        </label>
        <button class="btn" id="addNew">+ Add new song</button>
        <button class="btn primary" id="exportZip">Export ZIP</button>
      </div>
    </div>

    <div class="row">
      <!-- LEFT -->
      <div class="card left">
        <label>Search</label>
        <input id="search" placeholder="Search artist / title..." />

        <div class="divider"></div>

        <div class="small">
          Loaded variable: <span id="varName">—</span><br/>
          Songs: <span id="count">0</span>
        </div>

        <div class="list" id="list"></div>

        <div class="divider"></div>

        <label>Bulk import (CSV from Google Sheets)</label>
        <textarea id="csv" placeholder="Paste CSV here. Columns: artist,title,year,duration,category,style,cover (style can be 'Pop|Disco' or 'Pop, Disco')"></textarea>
        <div class="pillRow">
          <button class="btn" id="replaceFromCsv">Replace list from CSV</button>
          <button class="btn" id="mergeFromCsv">Merge CSV into list</button>
        </div>
        <div class="hint">
          Tip: Google Sheets → File → Download → CSV, then paste here.<br/>
          Duration format recommended: <span class="pill">HH:MM:SS</span> (e.g. 00:03:45)
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card right">
        <div class="grid2">
          <div>
            <label>Artist</label>
            <input id="artist" />
          </div>
          <div>
            <label>Title</label>
            <input id="title" />
          </div>

          <div>
            <label>Exact year</label>
            <input id="year" placeholder="e.g. 1987" inputmode="numeric" />
            <div class="hint" style="margin-top:6px;">
              Auto decade: when you type a year, the decade checkbox is set automatically.
            </div>
          </div>

          <div>
            <label>Duration (HH:MM:SS)</label>
            <input id="durationTime" type="time" step="1" value="00:00:00" />
          </div>
        </div>

        <label style="margin-top:14px;">Decade (Category)</label>
        <div class="pillRow" id="decadeBox"></div>
        <input id="category" placeholder="e.g. 80s Music" style="margin-top:8px;" />

        <label style="margin-top:14px;">Styles (multi-select)</label>
        <div class="pillRow" id="styleBox"></div>

        <div class="pillRow" style="margin-top:10px;">
          <input id="styleAdd" placeholder="Add a new style (e.g. Synthpop)" style="flex:1 1 260px; min-width:220px;" />
          <button class="btn" id="addStyleBtn">+ Add style</button>
        </div>

        <label style="margin-top:12px;">Styles (manual input - optional)</label>
        <input id="style" placeholder="e.g. Pop, Disco" />
        <div class="hint">Tip: use the checkboxes above. Manual input is optional.</div>

        <div class="coverBox">
          <div class="coverPreview"><img id="coverImg" src="img/default-cover.jpg" alt=""></div>
          <div style="flex:1 1 300px; min-width:260px;">
            <label>Cover filename (auto)</label>
            <input id="cover" placeholder='img/Artist - Title.jpg' />
            <div class="pillRow">
              <label class="btn">
                Upload cover
                <input id="coverFile" type="file" accept="image/*" style="display:none;">
              </label>
              <button class="btn" id="autoCover">Auto filename</button>
              <button class="btn" id="deleteSong">Delete song</button>
              <button class="btn primary" id="saveSong">Save changes</button>
            </div>
            <div class="hint">
              Uploaded covers are added to the exported ZIP under <span class="pill">img/</span>.<br/>
              (GitHub Pages cannot save uploads directly.)
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <h2 style="margin-top:0;">Style Manager</h2>
        <div class="hint">Add / rename / delete styles used by the checkboxes (updates all songs).</div>

        <div class="pillRow" style="margin-top:10px;">
          <input id="styleNewName" placeholder="New style name (e.g. Synthpop)" style="flex:1 1 260px; min-width:220px;" />
          <button class="btn" id="styleAddBtn2">+ Add</button>
        </div>

        <div class="list" id="styleManager" style="max-height:240px; margin-top:10px;"></div>

        <div class="divider"></div>

        <div class="small">
          Output format: <span class="pill">const songsX = [ { "artist": "...", ... } ];</span><br/>
          Hidden field per song: <span class="pill">addedAt</span> (auto, exported, not shown in list)
        </div>
      </div>
    </div>
  </div>

  <!-- JSZip for exporting ZIP -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <script>
    let varName = null;          // e.g. songsM
    let data = [];               // array of song objects
    let currentIndex = -1;       // selected song index
    let coverBlobs = new Map();  // coverPath -> Blob (only for uploaded covers)

    const $ = (id) => document.getElementById(id);

    const DECADES = ["60s Music","70s Music","80s Music","90s Music","2000s Music","2010s Music","2020s Music","Mixed Years"];

    let styleMaster = new Set([
      "Pop","Rock","Alternative Rock","Indie Rock","Indie Pop","Electronic","Synthpop","New Wave","Disco","Hip Hop",
      "R&B","Soul","Funk","House","Dance","Dance Pop","Trip-Hop","Soundtrack","Video Game Music","Classical","Country",
      "Punk Rock","Hard Rock","Soft Rock","Glam Rock","Industrial Metal","Latin Pop","Latin Rock","French Pop","French Rock",
      "City Pop","Comedy","Instrumental","Mashup"
    ]);

    function nowISO() {
      return new Date().toISOString();
    }

    function normalizeStyles(input){
      if(!input) return [];
      if(Array.isArray(input)) return input.filter(Boolean);
      return String(input)
        .split(/[\|,]/g)
        .map(s => s.trim())
        .filter(Boolean);
    }

    function sanitizeFilePart(s){
      return String(s || "")
        .replace(/[\/\\:*?"<>|]/g, "")
        .replace(/\s+/g, " ")
        .trim();
    }

    function buildCoverPath(artist, title){
      const a = sanitizeFilePart(artist);
      const t = sanitizeFilePart(title);
      if(!a || !t) return "img/default-cover.jpg";
      return `img/${a} - ${t}.jpg`;
    }

    function escapeHtml(str){
      return String(str||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // duration stored as "HH:MM:SS"
    function timeToDurationStr(t) {
      if (!t) return "";
      const parts = t.split(":").map(x => x.trim());
      if (parts.length === 2) return `${parts[0].padStart(2,"0")}:${parts[1].padStart(2,"0")}:00`;
      if (parts.length === 3) return `${parts[0].padStart(2,"0")}:${parts[1].padStart(2,"0")}:${parts[2].padStart(2,"0")}`;
      return "";
    }

    function durationStrToTime(d) {
      if (!d) return "00:00:00";
      const parts = String(d).split(":");
      if (parts.length === 3) return `${parts[0].padStart(2,"0")}:${parts[1].padStart(2,"0")}:${parts[2].padStart(2,"0")}`;
      return "00:00:00";
    }

    // Auto decade from year
    function decadeFromYear(yearStr){
      const y = parseInt(String(yearStr || "").trim(), 10);
      if (!Number.isFinite(y)) return "";
      if (y >= 1960 && y <= 1969) return "60s Music";
      if (y >= 1970 && y <= 1979) return "70s Music";
      if (y >= 1980 && y <= 1989) return "80s Music";
      if (y >= 1990 && y <= 1999) return "90s Music";
      if (y >= 2000 && y <= 2009) return "2000s Music";
      if (y >= 2010 && y <= 2019) return "2010s Music";
      if (y >= 2020 && y <= 2029) return "2020s Music";
      return "";
    }

    function sortData(){
      data.sort((x,y)=>{
        const ax = (x.artist||"").toLowerCase();
        const ay = (y.artist||"").toLowerCase();
        if(ax !== ay) return ax.localeCompare(ay);
        const tx = (x.title||"").toLowerCase();
        const ty = (y.title||"").toLowerCase();
        return tx.localeCompare(ty);
      });
    }

    function renderList(){
      const q = ($("search").value || "").toLowerCase();
      const list = $("list");
      list.innerHTML = "";

      const filtered = data
        .map((s, idx)=>({s, idx}))
        .filter(({s})=>{
          const hay = ((s.artist||"") + " " + (s.title||"") + " " + (s.year||"")).toLowerCase();
          return hay.includes(q);
        });

      filtered.forEach(({s, idx})=>{
        const div = document.createElement("div");
        div.className = "item" + (idx === currentIndex ? " active" : "");
        div.innerHTML = `
          <div><b>${escapeHtml(s.title || "(no title)")}</b></div>
          <div class="meta">
            ${escapeHtml(s.artist || "(no artist)")}
            ${s.year ? " • " + escapeHtml(s.year) : ""}
          </div>
        `;
        div.onclick = ()=> selectSong(idx);
        list.appendChild(div);
      });

      $("count").textContent = data.length;
      $("varName").textContent = varName || "—";
    }

    // ---- Decade checkbox UI ----
    function rebuildDecadeBox() {
      const box = $("decadeBox");
      box.innerHTML = "";

      DECADES.forEach(dec => {
        const id = `dec_${dec.replace(/\s+/g,"_")}`;
        const lbl = document.createElement("label");
        lbl.className = "pill";
        lbl.innerHTML = `<input type="checkbox" class="decadeCB" value="${dec}" id="${id}"> ${dec.replace(" Music","")}`;
        box.appendChild(lbl);
      });

      // single-choice behavior
      box.querySelectorAll(".decadeCB").forEach(cb => {
        cb.addEventListener("change", () => {
          if (cb.checked) {
            box.querySelectorAll(".decadeCB").forEach(other => {
              if (other !== cb) other.checked = false;
            });
            $("category").value = cb.value;
          } else {
            if ($("category").value === cb.value) $("category").value = "";
          }
        });
      });
    }

    function setSelectedDecade(category) {
      document.querySelectorAll(".decadeCB").forEach(cb => {
        cb.checked = (cb.value === category);
      });
    }

    // ---- Styles checkbox UI ----
    function rebuildStyleBox() {
      const box = $("styleBox");
      box.innerHTML = "";

      // expand master with what exists in data
      data.forEach(s => normalizeStyles(s.style).forEach(st => styleMaster.add(st)));

      Array.from(styleMaster)
        .map(s => s.trim())
        .filter(Boolean)
        .sort((a,b) => a.toLowerCase().localeCompare(b.toLowerCase()))
        .forEach(styleName => {
          const safe = styleName.replace(/\s+/g,"_").replace(/[^\w\-]/g,"");
          const id = `st_${safe}`;
          const lbl = document.createElement("label");
          lbl.className = "pill";
          lbl.innerHTML = `<input type="checkbox" class="styleCB" value="${escapeHtml(styleName)}" id="${id}"> ${escapeHtml(styleName)}`;
          box.appendChild(lbl);
        });

      box.querySelectorAll(".styleCB").forEach(cb => {
        cb.addEventListener("change", () => {
          $("style").value = getSelectedStyles().join(", ");
        });
      });
    }

    function getSelectedStyles() {
      return Array.from(document.querySelectorAll(".styleCB:checked"))
        .map(x => x.value)
        .map(s => s.trim())
        .filter(Boolean);
    }

    function setSelectedStyles(stylesArr) {
      const set = new Set((stylesArr || []).map(s => String(s).trim()).filter(Boolean));
      document.querySelectorAll(".styleCB").forEach(cb => {
        cb.checked = set.has(cb.value);
      });
      $("style").value = Array.from(set).join(", ");
    }

    function refreshCheckboxes() {
      rebuildDecadeBox();
      rebuildStyleBox();
      renderStyleManager();
    }

    // ---- Style Manager ----
    function renderStyleManager() {
      const box = $("styleManager");
      if (!box) return;
      box.innerHTML = "";

      const styles = Array.from(styleMaster)
        .map(s => s.trim())
        .filter(Boolean)
        .sort((a,b)=>a.toLowerCase().localeCompare(b.toLowerCase()));

      styles.forEach(st => {
        const row = document.createElement("div");
        row.className = "item";
        row.style.display = "flex";
        row.style.gap = "8px";
        row.style.alignItems = "center";

        row.innerHTML = `
          <input data-old="${escapeHtml(st)}" value="${escapeHtml(st)}" style="flex:1 1 auto; min-width:180px;" />
          <button class="btn" data-action="rename">Rename</button>
          <button class="btn" data-action="delete">Delete</button>
        `;

        const input = row.querySelector("input");
        const btnRename = row.querySelector('[data-action="rename"]');
        const btnDelete = row.querySelector('[data-action="delete"]');

        btnRename.onclick = () => {
          const oldName = input.getAttribute("data-old");
          const newName = input.value.trim();
          if (!newName) return;

          if (oldName === newName) return;

          styleMaster.delete(oldName);
          styleMaster.add(newName);

          // update in songs
          data.forEach(song => {
            const arr = normalizeStyles(song.style);
            const updated = arr.map(x => x === oldName ? newName : x);
            song.style = Array.from(new Set(updated)).filter(Boolean);
          });

          rebuildStyleBox();
          renderStyleManager();
          if (currentIndex >= 0) setSelectedStyles(normalizeStyles(data[currentIndex].style));
        };

        btnDelete.onclick = () => {
          const name = input.getAttribute("data-old");
          styleMaster.delete(name);

          data.forEach(song => {
            song.style = normalizeStyles(song.style).filter(x => x !== name);
          });

          rebuildStyleBox();
          renderStyleManager();
          if (currentIndex >= 0) setSelectedStyles(normalizeStyles(data[currentIndex].style));
        };

        box.appendChild(row);
      });
    }

    // ---- Select / Save ----
    function selectSong(idx){
      currentIndex = idx;
      const s = data[idx] || {};

      $("artist").value = s.artist || "";
      $("title").value = s.title || "";
      $("year").value = s.year || "";
      $("category").value = s.category || "";

      $("durationTime").value = durationStrToTime(s.duration || "");
      $("style").value = normalizeStyles(s.style).join(", ");

      setSelectedDecade(s.category || "");
      setSelectedStyles(normalizeStyles(s.style));

      $("cover").value = s.cover || "img/default-cover.jpg";
      $("coverImg").src = s.cover || "img/default-cover.jpg";

      renderList();
    }

    function saveCurrent(){
      if(currentIndex < 0) return;

      const artist = $("artist").value.trim();
      const title = $("title").value.trim();

      const pickedStyles = getSelectedStyles();
      const finalStyles = pickedStyles.length ? pickedStyles : normalizeStyles($("style").value);

      const duration = timeToDurationStr($("durationTime").value);
      const year = $("year").value.trim();

      const existingAddedAt = (data[currentIndex] && data[currentIndex].addedAt) ? data[currentIndex].addedAt : "";

      data[currentIndex] = {
        artist,
        title,
        duration: duration || "",
        year: year,
        style: finalStyles,
        category: $("category").value.trim(),
        cover: $("cover").value.trim() || "img/default-cover.jpg",
        addedAt: existingAddedAt || nowISO()
      };

      sortData();
      const newIdx = data.findIndex(s => s.artist === artist && s.title === title);
      currentIndex = newIdx >= 0 ? newIdx : 0;

      selectSong(currentIndex);
    }

    function addNewSong(){
      data.push({
        artist: "",
        title: "",
        duration: "00:00:00",
        year: "",
        style: [],
        category: "",
        cover: "img/default-cover.jpg",
        addedAt: nowISO()
      });
      sortData();
      currentIndex = data.findIndex(s => !s.artist && !s.title);
      if(currentIndex < 0) currentIndex = data.length - 1;
      selectSong(currentIndex);
    }

    function deleteCurrent(){
      if(currentIndex < 0) return;
      data.splice(currentIndex, 1);
      currentIndex = Math.min(currentIndex, data.length - 1);
      if(currentIndex >= 0) selectSong(currentIndex);
      else renderList();
    }

    // ---- Import JS file (songsX.js) ----
    $("jsFile").addEventListener("change", async (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;

      const text = await file.text();
      const m = text.match(/const\s+([A-Za-z0-9_]+)\s*=\s*\[/);
      if(!m){
        alert("Could not find 'const something = [' in this file.");
        return;
      }
      varName = m[1];

      try{
        const fn = new Function(text + `\nreturn ${varName};`);
        const arr = fn();
        if(!Array.isArray(arr)) throw new Error("Not an array");

        data = arr.map(s => ({
          artist: s.artist || "",
          title: s.title || "",
          duration: s.duration || "",
          year: s.year || "",
          style: Array.isArray(s.style) ? s.style : normalizeStyles(s.style),
          category: s.category || "",
          cover: s.cover || "img/default-cover.jpg",
          addedAt: s.addedAt || ""
        }));

        sortData();
        refreshCheckboxes();
        currentIndex = data.length ? 0 : -1;
        if(currentIndex >= 0) selectSong(currentIndex);
        else renderList();
      }catch(err){
        console.error(err);
        alert("Failed to load JS file. Check console for details.");
      }
    });

    // ---- Cover upload ----
    $("coverFile").addEventListener("change", async (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;

      const url = URL.createObjectURL(file);
      $("coverImg").src = url;

      const artist = $("artist").value.trim();
      const title = $("title").value.trim();
      const path = buildCoverPath(artist, title);

      $("cover").value = path;
      coverBlobs.set(path, file);
    });

    $("autoCover").addEventListener("click", ()=>{
      const artist = $("artist").value.trim();
      const title = $("title").value.trim();
      const path = buildCoverPath(artist, title);
      $("cover").value = path;
    });

    // ---- Auto decade from year ----
    $("year").addEventListener("input", ()=>{
      const dec = decadeFromYear($("year").value);
      if (dec) {
        $("category").value = dec;
        setSelectedDecade(dec);
      }
    });

    // ---- Styles add ----
    $("addStyleBtn").addEventListener("click", () => {
      const s = ($("styleAdd").value || "").trim();
      if (!s) return;
      styleMaster.add(s);
      $("styleAdd").value = "";
      rebuildStyleBox();
      renderStyleManager();
    });

    $("styleAddBtn2").addEventListener("click", () => {
      const s = ($("styleNewName").value || "").trim();
      if (!s) return;
      styleMaster.add(s);
      $("styleNewName").value = "";
      rebuildStyleBox();
      renderStyleManager();
    });

    // ---- CSV import (Option 2) ----
    function parseCsv(text){
      const rows = [];
      let i = 0, field = "", row = [], inQuotes = false;

      const pushField = ()=>{ row.push(field); field = ""; };
      const pushRow = ()=>{
        if(row.length === 1 && row[0].trim() === "") { row = []; return; }
        rows.push(row);
        row = [];
      };

      while(i < text.length){
        const c = text[i];

        if(c === '"'){
          if(inQuotes && text[i+1] === '"'){ field += '"'; i += 2; continue; }
          inQuotes = !inQuotes; i++; continue;
        }
        if(!inQuotes && c === ','){ pushField(); i++; continue; }
        if(!inQuotes && c === '\n'){ pushField(); pushRow(); i++; continue; }
        if(!inQuotes && c === '\r'){ i++; continue; }

        field += c; i++;
      }
      pushField(); pushRow();
      return rows;
    }

    function csvToSongs(csvText){
      const rows = parseCsv(csvText.trim());
      if(rows.length === 0) return [];

      const header = rows[0].map(x => (x||"").toLowerCase().trim());
      const hasHeader = header.includes("artist") && header.includes("title");

      const idx = (name)=>{
        const i = header.indexOf(name);
        return i >= 0 ? i : -1;
      };

      if(hasHeader){
        const aI = idx("artist");
        const tI = idx("title");
        const yI = idx("year");
        const dI = idx("duration");
        const cI = idx("category");
        const sI = idx("style");
        const covI = idx("cover");
        const addI = idx("addedat");

        return rows.slice(1).map(r=>{
          const artist = (r[aI]||"").trim();
          const title  = (r[tI]||"").trim();
          const cover = (covI >= 0 ? (r[covI]||"").trim() : "") || buildCoverPath(artist, title);
          const year = (yI >= 0 ? (r[yI]||"").trim() : "");

          // if category missing but year exists, auto
          const catRaw = (cI >= 0 ? (r[cI]||"").trim() : "");
          const category = catRaw || decadeFromYear(year) || "";

          const duration = (dI >= 0 ? (r[dI]||"").trim() : "");

          return {
            artist,
            title,
            year,
            duration,
            category,
            style: sI >= 0 ? normalizeStyles(r[sI]) : [],
            cover: cover || "img/default-cover.jpg",
            addedAt: addI >= 0 ? (r[addI]||"").trim() : ""
          };
        }).filter(s=>s.artist || s.title);
      } else {
        // No header: artist,title,year,duration,category,style,cover
        return rows.map(r=>{
          const artist = (r[0]||"").trim();
          const title  = (r[1]||"").trim();
          const year = (r[2]||"").trim();
          const duration = (r[3]||"").trim();
          const category = (r[4]||"").trim() || decadeFromYear(year) || "";
          const style = normalizeStyles(r[5]||"");
          const cover = (r[6]||"").trim() || buildCoverPath(artist, title);

          return { artist, title, year, duration, category, style, cover, addedAt: "" };
        }).filter(s=>s.artist || s.title);
      }
    }

    $("replaceFromCsv").addEventListener("click", ()=>{
      const csv = $("csv").value;
      if(!csv.trim()) return alert("Paste CSV first.");
      const songs = csvToSongs(csv);

      // ensure addedAt if missing
      songs.forEach(s => { if(!s.addedAt) s.addedAt = nowISO(); });

      data = songs;
      sortData();
      refreshCheckboxes();
      currentIndex = data.length ? 0 : -1;
      if(currentIndex >= 0) selectSong(currentIndex);
      else renderList();
    });

    $("mergeFromCsv").addEventListener("click", ()=>{
      const csv = $("csv").value;
      if(!csv.trim()) return alert("Paste CSV first.");
      const songs = csvToSongs(csv);

      const key = (s)=> (s.artist||"") + "||" + (s.title||"");
      const map = new Map(data.map(s => [key(s), s]));

      songs.forEach(s=>{
        const k = key(s);
        if(map.has(k)){
          const existing = map.get(k);

          existing.year = existing.year || s.year || "";
          existing.duration = existing.duration || s.duration || "";
          existing.category = existing.category || s.category || "";
          existing.style = (existing.style && existing.style.length) ? existing.style : s.style;
          existing.cover = (existing.cover && existing.cover !== "img/default-cover.jpg") ? existing.cover : s.cover;
          existing.addedAt = existing.addedAt || s.addedAt || "";
        } else {
          s.addedAt = s.addedAt || nowISO();
          map.set(k, s);
        }
      });

      data = Array.from(map.values());
      sortData();
      refreshCheckboxes();
      currentIndex = data.length ? 0 : -1;
      if(currentIndex >= 0) selectSong(currentIndex);
      else renderList();
    });

    // ---- Export ZIP ----
    function jsStringifySongs(){
      const items = data.map(s => ({
        "artist": s.artist || "",
        "title": s.title || "",
        "duration": s.duration || "",
        "year": s.year || "",
        "style": Array.isArray(s.style) ? s.style : [],
        "category": s.category || "",
        "cover": s.cover || "img/default-cover.jpg",
        "addedAt": s.addedAt || ""
      }));

      return `const ${varName || "songsX"} = ${JSON.stringify(items, null, 2)};\n`;
    }

    $("exportZip").addEventListener("click", async ()=>{
      if(!varName){
        alert("Import a songsX.js file first.");
        return;
      }

      const zip = new JSZip();
      zip.file(`${varName}.js`, jsStringifySongs());

      for(const [path, blob] of coverBlobs.entries()){
        const p = path.startsWith("img/") ? path : `img/${path}`;
        zip.file(p, blob);
      }

      const out = await zip.generateAsync({type:"blob"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(out);
      a.download = `${varName}_export.zip`;
      a.click();
    });

    // ---- Wire buttons ----
    $("addNew").addEventListener("click", addNewSong);
    $("saveSong").addEventListener("click", saveCurrent);
    $("deleteSong").addEventListener("click", deleteCurrent);
    $("search").addEventListener("input", renderList);

    // Init
    refreshCheckboxes();
    renderList();
  </script>
</body>
</html>
