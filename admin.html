<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cugell ‚Äì Admin</title>

<style>
    body{
        margin:0;
        padding:0;
        font-family:"Trebuchet MS", Arial, sans-serif;
        background: radial-gradient(circle at top, #4c2d63 0, #1b0f29 45%, #07050b 100%);
        color:#f7f1e3;
    }
    .container{
        max-width: 1200px;
        margin: 25px auto;
        padding: 20px;
        background: rgba(20,12,26,.55);
        border-radius: 14px;
        border: 1px solid rgba(231,207,154,.22);
        box-shadow: 0 0 25px rgba(0,0,0,0.55);
        backdrop-filter: blur(6px);
    }

    .top-nav{
        display:flex;
        gap:15px;
        justify-content:center;
        margin-bottom:15px;
    }
    .top-nav a{
        text-decoration:none;
        color:#f7f1e3;
        border:1px solid rgba(231,207,154,.35);
        padding:6px 14px;
        border-radius:999px;
        background: rgba(10,6,14,.35);
        font-size:14px;
    }
    .top-nav a.active{
        background: linear-gradient(180deg, rgba(241,228,196,.95), rgba(199,155,83,.82));
        color:#2a1540;
        border-color: rgba(231,207,154,.50);
        font-weight:900;
    }

    h2{ margin-top:0; }

    .card{
        background: rgba(0,0,0,.13);
        border-radius:14px;
        padding:14px;
        border:1px solid rgba(231,207,154,.25);
        margin-bottom:18px;
    }

    label{ display:block; font-size:12px; margin-bottom:4px; opacity:.9; }
    input, select{
        width:100%;
        padding:9px 10px;
        border-radius:8px;
        border:1px solid rgba(231,207,154,.30);
        background: rgba(10,6,14,.35);
        color:#f7f1e3;
        font-size:14px;
        margin-bottom:10px;
        box-sizing: border-box;
    }

    .btn{
        padding:8px 16px;
        border-radius:999px;
        border:1px solid rgba(231,207,154,.35);
        background: rgba(10,6,14,.35);
        color:#f7f1e3;
        cursor:pointer;
    }
    .btn.primary{
        background: linear-gradient(180deg, rgba(241,228,196,.95), rgba(199,155,83,.82));
        color:#2a1540;
        font-weight:900;
    }

    .status{
        padding:10px;
        border-radius:10px;
        border:1px solid rgba(231,207,154,.35);
        background: rgba(10,6,14,.28);
        margin-top:10px;
        font-size:14px;
    }
    .status.error{
        background: rgba(255,80,80,.18);
        border-color: rgba(255,120,120,.35);
    }
</style>
</head>

<body>
<div class="container">

    <nav class="top-nav">
        <a href="index.html">Songs</a>
        <a href="soundtracks.html">Soundtracks</a>
        <a href="admin.html" class="active">Admin</a>
    </nav>

    <h2>Admin ‚Äì GitHub Integration</h2>

    <div class="card">
        <label><b>GitHub Token (Never stored)</b></label>
        <input id="tokenInput" type="password" placeholder="github_pat_....">

        <button class="btn" id="testTokenBtn">üîç Test Token</button>

        <div id="tokenStatus" class="status">Enter your token and click Test.</div>
    </div>

    <script>
    /* --- FIXED CONFIG (OPTION A) --- */
    const GH_OWNER = "letouque";
    const GH_REPO = "Cugell-Songs";
    const GH_BRANCH = "main";
    const GH_PATH = "songs"; // folder
    </script>
<!-- PART 2 / 3 ‚Äì SONG EDITOR -->

<div class="card">
    <h2>2. Select File</h2>

    <div class="row" style="display:flex; gap:15px; flex-wrap:wrap;">
        <div>
            <label>Letter</label>
            <select id="letterSelect" style="min-width:120px;"></select>
        </div>

        <div>
            <label>&nbsp;</label>
            <button class="btn primary" id="loadFromGitHubBtn">üì• Load from GitHub</button>
        </div>

        <div>
            <label>&nbsp;</label>
            <button class="btn" id="saveToGitHubBtn" disabled>üíæ Save to GitHub</button>
        </div>
    </div>

    <div id="fileStatus" class="status">Choose a letter to load songs.</div>
</div>

<div class="card" style="display:flex; gap:20px; flex-wrap:wrap;">

    <!-- LEFT: SONG LIST -->
    <div style="flex:1 1 300px;">
        <h3>Songs in file</h3>

        <input id="searchList" placeholder="Search‚Ä¶" style="margin-bottom:10px; width:100%;">

        <div class="list-box" id="songsList" 
             style="max-height:500px; overflow:auto; border:1px solid rgba(231,207,154,.25); border-radius:8px;">
        </div>

        <button class="btn" id="addSongBtn" style="margin-top:10px;">+ Add Song</button>
    </div>

    <!-- RIGHT: EDITOR -->
    <div style="flex:1 1 420px;">
        <h3>Editor</h3>

        <label>Title</label>
        <input id="fTitle">

        <label>Artist</label>
        <input id="fArtist">

        <div style="display:flex; gap:10px;">
            <div style="flex:1;">
                <label>Year</label>
                <input id="fYear" type="number" min="1900" max="2100">
            </div>

            <div style="flex:1;">
                <label>Decade</label>
                <select id="fCategory"></select>
            </div>
        </div>

        <label>Duration (mm:ss)</label>
        <input id="fDuration" placeholder="03:28">

        <hr style="border-color:rgba(231,207,154,.2); margin:14px 0;">

        <label>Styles (Genres)</label>
        <div id="styleChips" class="chips" style="margin-bottom:8px;"></div>

        <div style="display:flex; gap:10px;">
            <input id="newStyle" placeholder="Add new style‚Ä¶" style="flex:1;">
            <button class="btn" id="addStyleBtn">Add</button>
        </div>

        <hr style="border-color:rgba(231,207,154,.2); margin:14px 0;">

        <label>Cover path</label>
        <input id="fCover" placeholder="img/Artist - Title.jpg">

        <div style="display:flex; gap:12px; align-items:center;">
            <div class="cover-img-box" style="
                width:120px; height:120px; 
                overflow:hidden; border-radius:10px;
                border:1px solid rgba(231,207,154,.35);
                background:rgba(0,0,0,.3);
            ">
                <img id="coverPreview" src="img/default-cover.jpg"
                     style="width:100%; height:100%; object-fit:cover;">
            </div>

            <div style="flex:1;">
                <input type="file" id="coverFile" accept="image/*">

                <button class="btn" id="downloadCoverBtn" disabled style="margin-top:6px;">
                    Download renamed cover
                </button>

                <div style="font-size:12px; opacity:.8; margin-top:5px;">
                    Suggested name: <code id="suggestedCoverName">Artist - Title.jpg</code>
                </div>
            </div>
        </div>

        <hr style="border-color:rgba(231,207,154,.2); margin:14px 0;">

        <div style="display:flex; justify-content:space-between;">
            <button class="btn primary" id="saveLocalBtn">Save (Local)</button>
            <button class="btn danger" id="deleteSongBtn">Delete</button>
        </div>
    </div>
</div>

<script>
/* ============================== */
/*         PART 2 JS LOGIC        */
/* ============================== */

let TOKEN = "";
let CURRENT_LETTER = "A";
let CURRENT_FILENAME = "";
let CURRENT_VARNAME = "";
let CURRENT_SHA = null;
let CURRENT_SONGS = [];
let SELECTED_INDEX = -1;

const DECADES = [
    "60s Music","70s Music","80s Music","90s Music",
    "2000s Music","2010s Music","2020s Music","Mixed Years"
];

let MASTER_STYLES = [
    "Pop","Rock","Soft Rock","Disco","Synthpop","New Wave","Pop Rock",
    "Alternative Rock","Electronic","Dance","Hip Hop","Soul","R&B",
    "French Pop","Indie Pop","Indie Rock","Punk Rock","Hard Rock",
    "Classical","Soundtrack"
];

function $(id){ return document.getElementById(id); }

/* --- Fill dropdowns --- */
(function initSelectors(){
    $("letterSelect").innerHTML = 
        ["0","A","B","C","D","E","F","G","H","I","J","K","L","M",
         "N","O","P","Q","R","S","T","U","V","W","X","Y","Z"]
        .map(l => `<option>${l}</option>`).join("");

    $("letterSelect").value = "A";

    $("fCategory").innerHTML = DECADES
        .map(d => `<option>${d}</option>`).join("");
})();
<!-- PART 3 / 3 ‚Äì GITHUB API + SAVE SYSTEM -->
<script>

/* ===============================================
    TOKEN HANDLING
   =============================================== */

$("testTokenBtn").addEventListener("click", async () => {
    TOKEN = $("tokenInput").value.trim();
    
    if (!TOKEN) {
        return setTokenStatus("‚ùå Please enter a token.", true);
    }

    setTokenStatus("‚è≥ Testing token‚Ä¶");

    try {
        const testUrl = `https://api.github.com/repos/${GH_OWNER}/${GH_REPO}`;
        const res = await fetch(testUrl, {
            headers: {
                "Authorization": `Bearer ${TOKEN}`,
                "Accept": "application/vnd.github+json"
            }
        });

        if (!res.ok) {
            return setTokenStatus("‚ùå Token invalid or insufficient permissions.", true);
        }

        setTokenStatus("‚úÖ Token is valid and has repo access!");
    }
    catch (err) {
        setTokenStatus("‚ùå Connection error: " + err.message, true);
    }
});

function setTokenStatus(msg, error=false){
    const el = $("tokenStatus");
    el.textContent = msg;
    el.className = "status" + (error ? " error" : "");
}


/* ===============================================
    GITHUB API UTILS
   =============================================== */

async function githubGetFile(path){
    if (!TOKEN) throw new Error("Token missing.");

    const url = `https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/contents/${path}?ref=${GH_BRANCH}`;

    const res = await fetch(url, {
        headers: {
            "Authorization": `Bearer ${TOKEN}`,
            "Accept": "application/vnd.github+json"
        }
    });

    if (!res.ok) {
        const err = await res.json().catch(()=>({}));
        throw new Error(`GitHub GET failed: ${res.status}\n${JSON.stringify(err)}`);
    }

    return await res.json();
}

async function githubPutFile(path, contentBase64, sha){
    if (!TOKEN) throw new Error("Token missing.");
    
    const url = `https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/contents/${path}`;

    const body = {
        message: `Update ${path}`,
        content: contentBase64,
        branch: GH_BRANCH
    };

    if (sha) body.sha = sha;

    const res = await fetch(url, {
        method: "PUT",
        headers: {
            "Authorization": `Bearer ${TOKEN}`,
            "Accept": "application/vnd.github+json",
            "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
    });

    if (!res.ok) {
        const err = await res.json().catch(()=>({}));
        throw new Error(`GitHub PUT failed: ${res.status}\n${JSON.stringify(err)}`);
    }

    return await res.json();
}


/* ===============================================
    FILE SELECTION
   =============================================== */

$("letterSelect").addEventListener("change", () => {
    CURRENT_LETTER = $("letterSelect").value;
    CURRENT_FILENAME = CURRENT_LETTER === "0" ? "songs_0.js" : `songs_${CURRENT_LETTER}.js`;
    CURRENT_VARNAME  = CURRENT_LETTER === "0" ? "songs0"     : `songs${CURRENT_LETTER}`;

    $("fileStatus").textContent = `Selected file: ${CURRENT_FILENAME}`;
});

/* initial file */
$("letterSelect").dispatchEvent(new Event("change"));


/* ===============================================
    LOAD FROM GITHUB
   =============================================== */

$("loadFromGitHubBtn").addEventListener("click", async () => {

    if (!TOKEN) return alert("Enter token first.");

    $("fileStatus").textContent = "‚è≥ Loading from GitHub‚Ä¶";

    const path = `${GH_PATH}/${CURRENT_FILENAME}`;

    try {
        const file = await githubGetFile(path);

        CURRENT_SHA = file.sha;

        const decoded = atob(file.content.replace(/\n/g,""));
        CURRENT_SONGS = parseSongs(decoded);

        SELECTED_INDEX = -1;

        renderSongsList();
        clearEditor();

        $("saveToGitHubBtn").disabled = false;
        $("fileStatus").textContent = `‚úÖ Loaded ${CURRENT_FILENAME} (${CURRENT_SONGS.length} songs)`;
    }
    catch (err) {
        $("fileStatus").textContent = "‚ùå " + err.message;
    }
});


/* ===============================================
    PARSE JS FILE ‚Üí ARRAY
   =============================================== */

function parseSongs(jsText){
    try {
        const fn = new Function(jsText + `\nreturn ${CURRENT_VARNAME};`);
        const arr = fn();

        if (!Array.isArray(arr)) throw new Error("Variable not found: " + CURRENT_VARNAME);

        return arr;
    }
    catch (err){
        throw new Error("Parsing error: " + err.message);
    }
}


/* ===============================================
    RENDER SONG LIST
   =============================================== */

function renderSongsList(){
    const list = $("songsList");
    const q = $("searchList").value.toLowerCase().trim();

    list.innerHTML = CURRENT_SONGS.map((s, i) => {
        const match = `${s.title} ${s.artist}`.toLowerCase().includes(q);
        if (!match && q) return "";

        return `
            <div class="song-row ${i===SELECTED_INDEX?'active':''}" data-i="${i}"
                style="padding:8px; border-bottom:1px solid rgba(255,255,255,.15); cursor:pointer;">
                <div><b>${s.title}</b></div>
                <div style="opacity:.8;">${s.artist}</div>
            </div>`;
    }).join("");

    list.querySelectorAll(".song-row").forEach(row =>
        row.addEventListener("click", () => {
            SELECTED_INDEX = parseInt(row.dataset.i, 10);
            loadSongIntoEditor();
            renderSongsList();
        })
    );
}

$("searchList").addEventListener("input", renderSongsList);


/* ===============================================
    EDITOR
   =============================================== */

function clearEditor(){
    $("fTitle").value = "";
    $("fArtist").value = "";
    $("fYear").value = "";
    $("fDuration").value = "";
    $("fCategory").value = DECADES[0];
    $("fCover").value = "img/default-cover.jpg";

    $("coverPreview").src = "img/default-cover.jpg";
    $("downloadCoverBtn").disabled = true;

    renderStyles([]);
}

function loadSongIntoEditor(){
    const s = CURRENT_SONGS[SELECTED_INDEX];
    if (!s) return;

    $("fTitle").value = s.title || "";
    $("fArtist").value = s.artist || "";
    $("fYear").value = s.year || "";
    $("fDuration").value = s.duration || "";
    $("fCategory").value = s.category || "";
    $("fCover").value = s.cover || "img/default-cover.jpg";

    $("coverPreview").src = s.cover || "img/default-cover.jpg";

    renderStyles(s.style || []);
}

function renderStyles(selected){
    $("styleChips").innerHTML = MASTER_STYLES.map(st => `
        <label class="chip">
            <input type="checkbox" value="${st}" ${selected.includes(st)?"checked":""}>
            ${st}
        </label>
    `).join("");
}

$("addStyleBtn").addEventListener("click", () => {
    const val = $("newStyle").value.trim();
    if (!val) return;

    if (!MASTER_STYLES.includes(val)) MASTER_STYLES.push(val);

    $("newStyle").value = "";

    const selected = Array.from(document.querySelectorAll("#styleChips input:checked"))
        .map(x => x.value);

    renderStyles([...selected, val]);
});


/* ===============================================
    LOCAL SAVE
   =============================================== */

$("saveLocalBtn").addEventListener("click", () => {
    if (SELECTED_INDEX < 0) return alert("Select a song first.");

    CURRENT_SONGS[SELECTED_INDEX] = {
        title: $("fTitle").value.trim(),
        artist: $("fArtist").value.trim(),
        year: $("fYear").value.trim(),
        duration: $("fDuration").value.trim(),
        category: $("fCategory").value,
        cover: $("fCover").value.trim(),
        style: Array.from(document.querySelectorAll("#styleChips input:checked"))
                .map(x => x.value)
    };

    renderSongsList();
});


$("deleteSongBtn").addEventListener("click", () => {
    if (SELECTED_INDEX < 0) return;

    if (!confirm("Delete this song?")) return;

    CURRENT_SONGS.splice(SELECTED_INDEX, 1);
    SELECTED_INDEX = -1;

    renderSongsList();
    clearEditor();
});


$("addSongBtn").addEventListener("click", () => {
    CURRENT_SONGS.push({
        title:"", artist:"", year:"", duration:"",
        category:"80s Music", cover:"img/default-cover.jpg",
        style:[]
    });

    SELECTED_INDEX = CURRENT_SONGS.length-1;

    renderSongsList();
    loadSongIntoEditor();
});


/* ===============================================
    COVER HANDLING
   =============================================== */

$("coverFile").addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;

    $("coverPreview").src = URL.createObjectURL(file);
    $("downloadCoverBtn").disabled = false;

    const name = slugCover(
        $("fArtist").value,
        $("fTitle").value
    );

    $("suggestedCoverName").textContent = name;
});

function slugCover(a, t){
    return `${a || "Unknown"} - ${t || "Untitled"}.jpg`
        .replace(/[*?"<>:|\\\/]/g, "");
}


/* ===============================================
    SAVE TO GITHUB (PUT API)
   =============================================== */

$("saveToGitHubBtn").addEventListener("click", async () => {

    if (!TOKEN) return alert("Enter your token first.");

    $("fileStatus").textContent = "‚è≥ Saving to GitHub‚Ä¶";

    try {
        const jsContent =
            `const ${CURRENT_VARNAME} = ` +
            JSON.stringify(CURRENT_SONGS, null, 2) +
            ";\n";

        const base64 = btoa(unescape(encodeURIComponent(jsContent)));

        const path = `${GH_PATH}/${CURRENT_FILENAME}`;

        const result = await githubPutFile(path, base64, CURRENT_SHA);

        CURRENT_SHA = result.content.sha;

        $("fileStatus").textContent = "‚úÖ Saved to GitHub successfully!";
    }
    catch (err) {
        $("fileStatus").textContent = "‚ùå " + err.message;
    }
});

</script>

</body>
</html>
