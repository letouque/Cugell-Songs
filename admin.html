<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Cugell – Admin</title>

<style>
    body{
        margin:0; padding:0;
        font-family:"Trebuchet MS", sans-serif;
        background: radial-gradient(circle at top, #4c2d63 0, #1b0f29 45%, #07050b 100%);
        color:#f7f1e3;
    }

    .container{
        max-width: 1300px;
        margin: 25px auto 40px;
        padding: 22px;
        background: rgba(30,18,40,.55);
        border-radius: 18px;
        backdrop-filter: blur(6px);
        border: 1px solid rgba(231,207,154,.35);
        box-shadow: 0 0 25px rgba(0,0,0,.65);
    }

    nav{
        display:flex;
        justify-content:center;
        gap:14px;
        margin-bottom:20px;
    }
    nav a{
        text-decoration:none;
        color:#f7f1e3;
        padding:7px 16px;
        border-radius:999px;
        border:1px solid rgba(231,207,154,.35);
        background: rgba(10,6,14,.35);
        font-size:14px;
    }
    nav a.active{
        background: linear-gradient(180deg,#f1e4c4,#c79b53);
        color:#2a1540;
        font-weight:900;
    }

    h1{ margin-top:0; font-size:26px; }
    .subtitle{ opacity:.85; font-size:13px; margin-bottom:16px; }

    .card{
        background: rgba(0,0,0,.18);
        border:1px solid rgba(231,207,154,.25);
        border-radius:14px;
        padding:16px;
        margin-bottom:18px;
        box-shadow: 0 6px 14px rgba(0,0,0,.35);
    }

    .row{
        display:flex;
        flex-wrap:wrap;
        gap:14px;
        align-items:center;
    }

    label{
        font-size:13px;
        opacity:.85;
    }
    input, select, textarea{
        width:100%;
        padding:9px 12px;
        border-radius:10px;
        border:1px solid rgba(231,207,154,.35);
        background: rgba(15,10,22,.45);
        color:#f7f1e3;
        font-size:14px;
    }

    textarea{ min-height:120px; resize:vertical; }

    .btn{
        cursor:pointer;
        padding:9px 14px;
        border-radius:999px;
        border:1px solid rgba(231,207,154,.35);
        background: rgba(255,255,255,.08);
        color:#f7f1e3;
        font-size:13px;
        display:inline-flex;
        align-items:center;
        gap:8px;
        user-select:none;
    }
    .btn.primary{
        background: linear-gradient(180deg,#f1e4c4,#c79b53);
        color:#2a1540;
        font-weight:900;
    }
    .btn.danger{
        background: rgba(255,0,0,.15);
        border-color: rgba(255,100,100,.5);
    }

    .list-box{
        max-height:520px;
        overflow:auto;
        border-radius:14px;
        border:1px solid rgba(231,207,154,.25);
        background: rgba(10,6,14,.25);
    }

    .song-row{
        padding:10px 14px;
        border-bottom:1px solid rgba(231,207,154,.18);
        cursor:pointer;
    }
    .song-row:hover{ background: rgba(83,54,96,.22); }
    .song-row.active{ background: rgba(83,54,96,.40); }

    .song-title{ font-weight:900; }
    .song-meta{ font-size:12px; opacity:.75; }

    .grid2{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap:18px;
    }
    @media(max-width:900px){
        .grid2{ grid-template-columns: 1fr; }
    }

    .chip{
        display:inline-flex;
        align-items:center;
        gap:6px;
        padding:5px 10px;
        border-radius:999px;
        border:1px solid rgba(231,207,154,.25);
        background: rgba(83,54,96,.2);
        font-size:13px;
    }

    .cover-preview{
        display:grid;
        grid-template-columns:120px 1fr;
        gap:10px;
    }
    .cover-img-box{
        width:120px; height:120px;
        border-radius:14px;
        overflow:hidden;
        border:1px solid rgba(231,207,154,.25);
    }
    .cover-img-box img{
        width:100%; height:100%; object-fit:cover;
    }

    .status{
        margin-top:14px;
        padding:10px 14px;
        border-radius:12px;
        border:1px solid rgba(231,207,154,.25);
        background: rgba(0,0,0,.28);
        font-size:13px;
    }
    .status.error{
        background: rgba(255,60,60,.18);
        border-color: rgba(255,120,120,.45);
    }
</style>
</head>

<body>
<div class="container">

<nav>
    <a href="index.html">Songs</a>
    <a href="soundtracks.html">Soundtracks</a>
    <a class="active">Admin</a>
</nav>

<h1>Admin – Edit Songs (GitHub Connected)</h1>
<div class="subtitle">
    Modification en direct sur GitHub sans téléchargement ni upload manuel.
</div>

<div class="card">
    <h3>1. GitHub Access</h3>

    <div class="row">
        <div style="flex:1 1 200px;">
            <label>GitHub Token (secret)</label>
            <input type="password" id="gh_token" placeholder="ghp_xxxxxxxxxxxx">
        </div>

        <div style="flex:1 1 140px;">
            <label>Owner</label>
            <input type="text" id="gh_owner" value="letouque">
        </div>

        <div style="flex:1 1 160px;">
            <label>Repository</label>
            <input type="text" id="gh_repo" value="Cugell-Songs">
        </div>

        <div style="flex:1 1 120px;">
            <label>Branch</label>
            <input type="text" id="gh_branch" value="main">
        </div>

        <div>
            <label>&nbsp;</label>
            <button class="btn primary" id="connectBtn">Connect</button>
        </div>
    </div>

    <div id="status" class="status">Waiting for connection…</div>
</div>
<!-- PART 2 / 3 -->
<div class="card">
    <h3>2. Select songs_#.js file</h3>

    <div class="row">
        <div style="flex:1 1 140px;">
            <label>Letter</label>
            <select id="letterSelect"></select>
        </div>

        <div>
            <label>&nbsp;</label>
            <button class="btn" id="loadGithubBtn">Load from GitHub</button>
        </div>

        <div>
            <label>&nbsp;</label>
            <button class="btn" id="saveGithubBtn">Save to GitHub</button>
        </div>
    </div>
</div>

<div class="grid2">

    <!-- LEFT: list -->
    <div class="card">
        <div class="row" style="justify-content:space-between;">
            <h3 style="margin:0;">Songs in file</h3>
            <button class="btn" id="addNewBtn">+ Add song</button>
        </div>

        <input type="text" id="searchList" placeholder="Search…" style="margin:12px 0;">

        <div class="list-box" id="songsList"></div>
    </div>

    <!-- RIGHT: editor -->
    <div class="card">
        <h3>Edit song</h3>

        <div class="row">
            <div style="flex:1 1 200px;">
                <label>Title</label>
                <input id="fTitle">
            </div>
            <div style="flex:1 1 200px;">
                <label>Artist</label>
                <input id="fArtist">
            </div>
        </div>

        <div class="row" style="margin-top:10px;">
            <div style="flex:1 1 120px;">
                <label>Year</label>
                <input id="fYear" type="number" min="1900" max="2100">
            </div>

            <div style="flex:1 1 200px;">
                <label>Decade</label>
                <select id="fCategory"></select>
            </div>

            <div style="flex:1 1 200px;">
                <label>Duration (mm:ss)</label>
                <input id="fDuration" placeholder="03:28">
            </div>
        </div>

        <div style="margin-top:12px;">
            <label>Styles (genres)</label>
            <div id="styleChips" class="chips"></div>

            <div class="row" style="margin-top:8px;">
                <input id="newStyle" placeholder="Add new style…" style="flex:1;">
                <button class="btn" id="addStyleBtn">Add</button>
            </div>
        </div>

        <div style="margin-top:14px;">
            <label>Cover path</label>
            <input id="fCover" placeholder="img/Artist - Title.jpg">

            <div class="cover-preview" style="margin-top:10px;">
                <div class="cover-img-box">
                    <img id="coverPreview" src="img/default-cover.jpg">
                </div>
                <div>
                    <label>Upload preview</label>
                    <input type="file" id="coverFile" accept="image/*">

                    <button class="btn" id="downloadCoverBtn" disabled
                        style="margin-top:8px;">Download renamed cover</button>

                    <div class="status" style="margin-top:8px; font-size:12px; opacity:.8;">
                        Suggested name: <code id="suggestedCover">Artist - Title.jpg</code>
                    </div>
                </div>
            </div>
        </div>

        <div class="row" style="margin-top:16px; justify-content:space-between;">
            <button class="btn primary" id="saveLocalBtn">Save (Local)</button>
            <button class="btn danger" id="deleteBtn">Delete</button>
        </div>
    </div>
</div>
<script>
/* ============================================================
   CONFIG
   ============================================================ */
const GITHUB_USER = "letouque";
const GITHUB_REPO = "Cugell-Songs";
const GITHUB_BRANCH = "main";

// ⚠️ MET TON TOKEN ICI (PRIVATE) OU JE TE FAIS UN CHAMP HTML INPUT
let GITHUB_TOKEN = "";  // <-- À REMPLIR par toi


/* ============================================================
   STATE
   ============================================================ */
let state = {
    letter: "A",
    varName: "songsA",
    fileName: "songs_A.js",
    songs: [],
    selectedIndex: -1,
    coverBlob: null,
};

/* ============================================================
   TOOLS
   ============================================================ */
const $ = (id) => document.getElementById(id);

const escapeHtml = (txt) =>
    String(txt || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");

const slug = (s) =>
    String(s || "")
        .replace(/[\/\\:*?"<>|]/g, "")
        .trim();

/** Extract array from loaded JS */
function parseJsArray(code, varName) {
    try {
        const fn = new Function(code + `; return ${varName};`);
        const arr = fn();
        if (!Array.isArray(arr)) throw "Invalid array";
        return arr;
    } catch (e) {
        console.error(e);
        throw new Error("Cannot extract " + varName + " from JS file");
    }
}

/* ============================================================== 
   LOAD songs_#.js FROM GITHUB
   ============================================================== */
async function githubLoadFile() {
    const path = `songs/${state.fileName}`;
    const url = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_BRANCH}/${path}`;

    $("status").className = "status";
    $("status").innerHTML = `Loading <code>${path}</code> from GitHub…`;

    const res = await fetch(url);

    if (!res.ok) {
        $("status").className = "status error";
        $("status").textContent = "Could not load from GitHub.";
        return;
    }

    const text = await res.text();

    try {
        state.songs = parseJsArray(text, state.varName);
    } catch (e) {
        $("status").className = "status error";
        $("status").textContent = "Parsing error: " + e;
        return;
    }

    // Normalize songs
    state.songs = state.songs.map((s) => ({
        artist: s.artist || "",
        title: s.title || "",
        year: s.year || "",
        duration: s.duration || "",
        category: s.category || "",
        style: Array.isArray(s.style) ? s.style : [],
        cover: s.cover || "img/default-cover.jpg",
        addedAt: s.addedAt || new Date().toISOString(),
    }));

    state.selectedIndex = -1;

    renderList();
    clearEditor();

    $("status").className = "status";
    $("status").innerHTML = `Loaded <b>${state.fileName}</b> from GitHub (${state.songs.length} songs).`;
}

/* ============================================================== 
   SAVE TO GITHUB (commit)
   ============================================================== */
async function githubSaveFile() {
    if (!GITHUB_TOKEN) {
        alert("⚠️ No GitHub token set. I can add a field so you can paste it.");
        return;
    }

    const path = `songs/${state.fileName}`;

    // Format JS output
    const jsText = `const ${state.varName} = ${JSON.stringify(state.songs, null, 2)};\n`;

    // Base64 encode
    const base64 = btoa(unescape(encodeURIComponent(jsText)));

    // Get the current file SHA
    const metaRes = await fetch(
        `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${path}`,
        {
            headers: { Authorization: `token ${GITHUB_TOKEN}` },
        }
    );

    const meta = await metaRes.json();
    const sha = meta.sha;

    // Commit request
    const body = {
        message: `Update ${state.fileName}`,
        content: base64,
        sha,
        branch: GITHUB_BRANCH,
    };

    $("status").innerHTML = "Committing to GitHub…";

    const res = await fetch(
        `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${path}`,
        {
            method: "PUT",
            headers: {
                Authorization: `token ${GITHUB_TOKEN}`,
                "Content-Type": "application/json",
            },
            body: JSON.stringify(body),
        }
    );

    if (!res.ok) {
        const t = await res.text();
        $("status").className = "status error";
        $("status").textContent = "GitHub error: " + t;
        return;
    }

    $("status").className = "status";
    $("status").innerHTML = `Saved <b>${state.fileName}</b> to GitHub.`;
}

/* ============================================================== 
   RENDER LIST
   ============================================================== */
function renderList() {
    const q = $("searchList").value.toLowerCase();
    const box = $("songsList");

    const filtered = state.songs
        .map((s, i) => ({ s, i }))
        .filter(({ s }) => {
            const hay = (s.artist + " " + s.title).toLowerCase();
            return hay.includes(q);
        });

    box.innerHTML = filtered
        .map(
            ({ s, i }) => `
        <div class="list-item ${i === state.selectedIndex ? "active" : ""}" 
             data-i="${i}">
            <b>${escapeHtml(s.title)}</b><br>
            <span style="opacity:.8">${escapeHtml(s.artist)}</span>
        </div>
    `
        )
        .join("");

    box.querySelectorAll(".list-item").forEach((el) =>
        el.addEventListener("click", () => {
            selectSong(parseInt(el.dataset.i));
        })
    );
}

/* ============================================================== 
   EDITOR MANAGEMENT
   ============================================================== */
function clearEditor() {
    $("fTitle").value = "";
    $("fArtist").value = "";
    $("fYear").value = "";
    $("fDuration").value = "";
    $("fCover").value = "img/default-cover.jpg";
    $("coverPreview").src = "img/default-cover.jpg";

    renderStyles([]);
}

function selectSong(i) {
    state.selectedIndex = i;
    renderList();

    const s = state.songs[i];
    $("fTitle").value = s.title;
    $("fArtist").value = s.artist;
    $("fYear").value = s.year;
    $("fDuration").value = s.duration;
    $("fCover").value = s.cover;

    $("coverPreview").src = s.cover;
    $("suggestedCover").textContent = slug(s.artist) + " - " + slug(s.title) + ".jpg";

    renderStyles(s.style);
}

/* ============================================================== 
   SAVE LOCAL
   ============================================================== */
function saveLocal() {
    if (state.selectedIndex < 0) return;

    const s = state.songs[state.selectedIndex];
    s.title = $("fTitle").value.trim();
    s.artist = $("fArtist").value.trim();
    s.year = $("fYear").value.trim();
    s.duration = $("fDuration").value.trim();
    s.cover = $("fCover").value.trim();

    s.style = Array.from(document.querySelectorAll(".styleCheck:checked")).map(
        (x) => x.value
    );

    renderList();
    $("status").textContent = "Saved locally. Export or Save to GitHub.";
}

/* ============================================================== 
   STYLES
   ============================================================== */
let masterStyles = [
    "Pop",
    "Rock",
    "Disco",
    "Hip Hop",
    "Electronic",
    "Indie",
    "Soul",
    "New Wave",
    "Soundtrack",
];

function renderStyles(selected) {
    const box = $("styleChips");
    box.innerHTML = masterStyles
        .map(
            (st) => `
        <label class="chip">
            <input type="checkbox" class="styleCheck" value="${escapeHtml(st)}"
                ${selected.includes(st) ? "checked" : ""}>
            ${escapeHtml(st)}
        </label>
        `
        )
        .join("");
}

/* ============================================================== 
   ADD STYLE
   ============================================================== */
$("addStyleBtn").onclick = () => {
    const st = $("newStyle").value.trim();
    if (!st) return;
    if (!masterStyles.includes(st)) masterStyles.push(st);
    $("newStyle").value = "";
    renderStyles([]);
};

/* ============================================================== 
   ADD NEW SONG
   ============================================================== */
$("addNewBtn").onclick = () => {
    state.songs.push({
        artist: "",
        title: "",
        year: "",
        duration: "",
        category: "",
        style: [],
        cover: "img/default-cover.jpg",
        addedAt: new Date().toISOString(),
    });

    state.selectedIndex = state.songs.length - 1;
    renderList();
    selectSong(state.selectedIndex);
};

/* ============================================================== 
   DELETE SONG
   ============================================================== */
$("deleteBtn").onclick = () => {
    if (state.selectedIndex < 0) return;
    state.songs.splice(state.selectedIndex, 1);
    state.selectedIndex = -1;
    renderList();
    clearEditor();
};

/* ============================================================== 
   EXPORT JS
   ============================================================== */
$("exportBtn").onclick = () => {
    const js = `const ${state.varName} = ${JSON.stringify(
        state.songs,
        null,
        2
    )};\n`;
    const blob = new Blob([js], { type: "application/javascript" });

    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = state.fileName;
    a.click();
};

/* ============================================================== 
   COVER UPLOAD
   ============================================================== */
$("coverFile").onchange = (e) => {
    const f = e.target.files[0];
    if (!f) return;

    const url = URL.createObjectURL(f);
    $("coverPreview").src = url;
    state.coverBlob = f;

    $("downloadCoverBtn").disabled = false;
    $("suggestedCover").textContent =
        slug($("fArtist").value) + " - " + slug($("fTitle").value) + ".jpg";
};

$("downloadCoverBtn").onclick = () => {
    if (!state.coverBlob) return;

    const filename =
        slug($("fArtist").value) + " - " + slug($("fTitle").value) + ".jpg";
    const a = document.createElement("a");
    a.href = URL.createObjectURL(state.coverBlob);
    a.download = filename;
    a.click();

    $("fCover").value = "img/" + filename;
};

/* ============================================================== 
   UI WIRING
   ============================================================== */
function rebuildLetterSelect() {
    const letters = ["0", ..."ABCDEFGHIJKLMNOPQRSTUVWXYZ"];
    $("letterSelect").innerHTML = letters
        .map((l) => `<option value="${l}">${l}</option>`)
        .join("");
    $("letterSelect").value = state.letter;
}

$("letterSelect").onchange = () => {
    const L = $("letterSelect").value;
    state.letter = L;
    state.varName = L === "0" ? "songs0" : "songs" + L;
    state.fileName = L === "0" ? "songs_0.js" : `songs_${L}.js`;

    renderList();
    clearEditor();
};

$("searchList").oninput = renderList;
$("saveLocalBtn").onclick = saveLocal;
$("loadGithubBtn").onclick = githubLoadFile;
$("saveGithubBtn").onclick = githubSaveFile;


/* ============================================================== 
   INITIALIZE
   ============================================================== */
rebuildLetterSelect();
renderList();
clearEditor();
$("status").textContent = "Ready.";
</script>

