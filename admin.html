<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cugell – Admin (Songs)</title>

  <style>
    body{
      margin:0; padding:0;
      font-family:"Trebuchet MS", Arial, sans-serif;
      background: radial-gradient(circle at top, #4c2d63 0, #1b0f29 45%, #07050b 100%);
      color:#f7f1e3;
    }
    .container{
      max-width: 1300px;
      margin: 26px auto 50px;
      padding: 18px;
      background: rgba(20,12,26,.55);
      border-radius: 18px;
      box-shadow: 0 0 25px rgba(0,0,0,0.65);
      border: 1px solid rgba(231,207,154,.22);
      backdrop-filter: blur(6px);
    }
    .top-nav{
      display:flex;
      justify-content:center;
      gap:12px;
      margin-bottom:14px;
      flex-wrap:wrap;
    }
    .top-nav a{
      text-decoration:none;
      color:#f7f1e3;
      font-size:14px;
      padding:7px 14px;
      border-radius:999px;
      border:1px solid rgba(231,207,154,.35);
      background: rgba(10,6,14,.35);
    }
    .top-nav a.active{
      background: linear-gradient(180deg, rgba(241,228,196,.95), rgba(199,155,83,.82));
      color:#2a1540;
      font-weight:900;
      border-color: rgba(231,207,154,.50);
    }

    h1{ margin:8px 0 4px; font-size: 24px; }
    .sub{ opacity:.85; font-size: 13px; margin-bottom: 14px; }

    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .card{
      border-radius: 16px;
      border: 1px solid rgba(231,207,154,.22);
      background: rgba(0,0,0,.14);
      box-shadow: 0 10px 18px rgba(0,0,0,.22);
      padding: 14px;
    }

    label{ font-size: 12px; opacity:.9; display:block; margin-bottom: 6px; }
    input[type="text"], input[type="number"], select, textarea{
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(231,207,154,.30);
      background: rgba(10,6,14,.35);
      color:#f7f1e3;
      outline:none;
      font-size: 14px;
      box-sizing: border-box;
    }
    textarea{ min-height: 120px; resize: vertical; }

    .btn{
      cursor:pointer;
      user-select:none;
      border-radius:999px;
      padding:9px 14px;
      border:1px solid rgba(231,207,154,.26);
      background: rgba(10,6,14,.28);
      color:#f7f1e3;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn.primary{
      background: linear-gradient(180deg, rgba(241,228,196,.95), rgba(199,155,83,.82));
      color:#2a1540;
      font-weight:900;
      border-color: rgba(231,207,154,.45);
    }
    .btn.danger{
      border-color: rgba(255,120,120,.35);
      background: rgba(255,80,80,.12);
    }

    .grid2{ display:grid; grid-template-columns: 1.1fr .9fr; gap: 12px; }
    @media (max-width: 980px){ .grid2{ grid-template-columns: 1fr; } }

    .songs-list{
      max-height: 520px;
      overflow:auto;
      border-radius: 14px;
      border: 1px solid rgba(231,207,154,.18);
      background: rgba(10,6,14,.20);
    }
    .song-row{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(231,207,154,.12);
      cursor:pointer;
    }
    .song-row:hover{ background: rgba(83,54,96,.18); }
    .song-row.active{ background: rgba(83,54,96,.28); }
    .song-row .t{ font-weight: 900; }
    .song-row .a{ opacity:.9; }
    .song-row .m{ opacity:.75; font-size: 12px; margin-top: 2px; }

    .form-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 720px){ .form-grid{ grid-template-columns: 1fr; } }

    .chips{
      display:flex; flex-wrap:wrap; gap:8px;
    }
    .chip{
      border-radius:999px;
      padding:6px 10px;
      border:1px solid rgba(231,207,154,.20);
      background: rgba(83,54,96,.16);
      font-size: 13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .chip input{ margin:0; }

    .cover-preview{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap: 10px;
      align-items:center;
    }
    .cover-box{
      width:120px; height:120px;
      border-radius:14px;
      overflow:hidden;
      border:1px solid rgba(231,207,154,.22);
      background: rgba(10,6,14,.35);
    }
    .cover-box img{ width:100%; height:100%; object-fit:cover; display:block; }
    .muted{ opacity:.75; font-size: 12px; line-height: 1.35; }

    .status{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(231,207,154,.18);
      background: rgba(0,0,0,.14);
      font-size: 13px;
      opacity: .95;
    }
    .status.error{
      border-color: rgba(255,120,120,.35);
      background: rgba(255,80,80,.12);
    }
    code{
      background: rgba(255,255,255,.08);
      border:1px solid rgba(231,207,154,.18);
      padding:2px 6px;
      border-radius:8px;
      font-size:12px;
      display:inline-block;
      max-width:100%;
      overflow:auto;
      white-space:nowrap;
    }
  </style>
</head>

<body>
  <div class="container">
    <nav class="top-nav">
      <a href="index.html">Songs</a>
      <a href="soundtracks.html">Soundtracks</a>
      <a href="admin.html" class="active">Admin</a>
    </nav>

    <h1>Admin – Edit Songs Files</h1>
    <div class="sub">
      Load one file (<code>songs/songs_A.js</code> etc), edit, then export and upload back to GitHub.
      <br><b>Rule:</b> <code>songs_0.js</code> must define <code>const songs0 = [...]</code>.
    </div>

    <div class="card">
      <div class="row">
        <div style="min-width:240px; flex:1 1 240px;">
          <label>Choose file letter</label>
          <select id="letterSelect"></select>
        </div>

        <div style="min-width:260px; flex:1 1 260px;">
          <label>Load from website (GitHub Pages)</label>
          <div class="row">
            <button class="btn" id="loadFromSiteBtn">Load from site</button>
            <span class="muted">Loads: <code id="sitePath">songs/songs_A.js</code></span>
          </div>
        </div>

        <div style="min-width:260px; flex:1 1 260px;">
          <label>Or import local file</label>
          <input type="file" id="localFile" accept=".js" />
        </div>

        <div style="min-width:240px; flex:1 1 240px;">
          <label>Search in this file</label>
          <input type="text" id="listSearch" placeholder="Search title / artist / year / genre…" />
        </div>

        <div>
          <label>&nbsp;</label>
          <button class="btn primary" id="exportBtn">Export .js</button>
        </div>
      </div>

      <div id="status" class="status">Ready.</div>
    </div>

    <div class="grid2" style="margin-top:12px;">
      <!-- LEFT: list -->
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div style="font-weight:900;">Songs in file</div>
          <button class="btn" id="addNewBtn">+ Add Song</button>
        </div>
        <div class="muted" style="margin:8px 0 10px;">
          Click a song to edit. Sorting/export is always by <b>Artist → Title</b>.
        </div>
        <div class="songs-list" id="songsList"></div>
      </div>

      <!-- RIGHT: editor -->
      <div class="card">
        <div style="font-weight:900; margin-bottom:10px;">Editor</div>

        <div class="form-grid">
          <div>
            <label>Title</label>
            <input type="text" id="fTitle" />
          </div>
          <div>
            <label>Artist</label>
            <input type="text" id="fArtist" />
          </div>

          <div>
            <label>Year (exact)</label>
            <input type="number" id="fYear" min="0" max="9999" placeholder="e.g. 1975" />
          </div>

          <div>
            <label>Decade category</label>
            <select id="fCategory"></select>
          </div>

          <div>
            <label>Duration (mm:ss)</label>
            <div class="row" style="gap:8px;">
              <select id="fMin" style="max-width:110px;"></select>
              <select id="fSec" style="max-width:110px;"></select>
              <input type="text" id="fDuration" placeholder="or type mm:ss" style="flex:1 1 140px;" />
            </div>
            <div class="muted" style="margin-top:6px;">Tip: use dropdowns; it auto-fills mm:ss.</div>
          </div>

          <div>
            <label>Added at (hidden on public page)</label>
            <input type="text" id="fAddedAt" readonly />
          </div>
        </div>

        <div style="margin-top:12px;">
          <label>Genres / styles (multi-select)</label>
          <div class="chips" id="styleChips"></div>

          <div class="row" style="margin-top:10px;">
            <div style="flex: 1 1 240px;">
              <label>Add new style</label>
              <input type="text" id="newStyle" placeholder="e.g. Synthpop" />
            </div>
            <div>
              <label>&nbsp;</label>
              <button class="btn" id="addStyleBtn">Add style</button>
            </div>
          </div>
        </div>

        <div style="margin-top:12px;">
          <label>Cover path (in img/)</label>
          <input type="text" id="fCover" placeholder="img/Artist - Title.jpg" />

          <div class="cover-preview" style="margin-top:10px;">
            <div class="cover-box">
              <img id="coverImg" src="img/default-cover.jpg" alt="cover preview"
                   onerror="this.onerror=null;this.src='img/default-cover.jpg';">
            </div>
            <div>
              <div class="muted">
                Optional: pick an image file to preview, and download it renamed for your <code>img/</code> folder.
              </div>
              <div class="row" style="margin-top:8px;">
                <input type="file" id="coverFile" accept="image/*" />
                <button class="btn" id="downloadCoverBtn" disabled>Download renamed cover</button>
              </div>
              <div class="muted" style="margin-top:6px;">
                Suggested filename = <code id="suggestedCoverName">Artist - Title.jpg</code>
              </div>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top:14px; justify-content:space-between;">
          <button class="btn" id="saveBtn">Save changes</button>
          <button class="btn danger" id="deleteBtn">Delete song</button>
        </div>
      </div>
    </div>

    <!-- Optional: bulk CSV (paste) -->
    <div class="card" style="margin-top:12px;">
      <div style="font-weight:900;">Bulk (optional) – Import CSV into current file</div>
      <div class="muted" style="margin:8px 0 10px;">
        Paste CSV with headers: <code>artist,title,year,category,style,duration,cover,addedAt</code><br>
        style can be separated by <code>|</code> or comma.
      </div>
      <textarea id="csvBox" placeholder="artist,title,year,category,style,duration,cover,addedAt"></textarea>
      <div class="row" style="margin-top:10px;">
        <button class="btn" id="importCsvBtn">Import CSV (replace file content)</button>
        <button class="btn" id="exportCsvBtn">Export CSV</button>
      </div>
    </div>

  </div>

<script>
  const decadeOrder = ["60s Music","70s Music","80s Music","90s Music","2000s Music","2010s Music","2020s Music","Mixed Years"];
  const letters = ["0","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];

  // Master styles list (editable). It auto-adds any new styles found in songs too.
  let masterStyles = [
    "Pop","Rock","Soft Rock","Disco","Synthpop","New Wave","Pop Rock","Alternative Rock","Electronic","Dance",
    "Hip Hop","Soul","R&B","French Pop","Indie Pop","Indie Rock","Punk Rock","Hard Rock","Classical","Soundtrack"
  ];

  const state = {
    letter: "A",
    varName: "songsA",
    fileName: "songs_A.js",
    songs: [],
    selectedIndex: -1,
    coverBlob: null
  };

  function $(id){ return document.getElementById(id); }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function normArray(val){
    if (!val) return [];
    if (Array.isArray(val)) return val;
    return String(val).split(/[\|,]/g).map(v => v.trim()).filter(Boolean);
  }

  function slugCoverName(artist, title){
    const clean = (s) => String(s||"")
      .replaceAll("/", "-")
      .replaceAll("\\", "-")
      .replaceAll(":", "")
      .replaceAll("*", "")
      .replaceAll("?", "")
      .replaceAll('"', "")
      .replaceAll("<", "")
      .replaceAll(">", "")
      .replaceAll("|", "")
      .trim();
    const a = clean(artist) || "Unknown Artist";
    const t = clean(title) || "Unknown Title";
    return `${a} - ${t}.jpg`;
  }

  function setStatus(msg, isError=false){
    const el = $("status");
    el.className = "status" + (isError ? " error" : "");
    el.innerHTML = msg;
  }

  function computeVarName(letter){
    if (letter === "0") return "songs0";
    return "songs" + letter;
  }
  function computeFileName(letter){
    if (letter === "0") return "songs_0.js";
    return `songs_${letter}.js`;
  }

  function fillLetterSelect(){
    const sel = $("letterSelect");
    sel.innerHTML = letters.map(l => `<option value="${l}">${l}</option>`).join("");
    sel.value = state.letter;
  }

  function fillDecades(){
    const sel = $("fCategory");
    sel.innerHTML = decadeOrder.map(d => `<option value="${escapeHtml(d)}">${escapeHtml(d)}</option>`).join("");
  }

  function fillDurationPickers(){
    const min = $("fMin");
    const sec = $("fSec");
    min.innerHTML = Array.from({length: 31}, (_,i)=>`<option value="${i}">${String(i).padStart(2,"0")}</option>`).join("");
    sec.innerHTML = Array.from({length: 60}, (_,i)=>`<option value="${i}">${String(i).padStart(2,"0")}</option>`).join("");
  }

  function durationFromPickers(){
    const m = parseInt($("fMin").value || "0", 10);
    const s = parseInt($("fSec").value || "0", 10);
    return String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
  }

  function parseDurationFlexible(str){
    const t = String(str||"").trim();
    if (!t) return "";
    // accept "3 min 28" or "03:28" or "3:28"
    const m1 = t.match(/^(\d+)\s*min\s*(\d+)\s*$/i);
    if (m1){
      const mm = parseInt(m1[1],10);
      const ss = parseInt(m1[2],10);
      return String(mm).padStart(2,"0")+":"+String(ss).padStart(2,"0");
    }
    const m2 = t.match(/^(\d{1,2}):(\d{2})$/);
    if (m2){
      return String(parseInt(m2[1],10)).padStart(2,"0")+":"+String(parseInt(m2[2],10)).padStart(2,"0");
    }
    return t;
  }

  function sortSongs(){
    state.songs.sort((a,b)=>{
      const aa = (a.artist||"").toLowerCase();
      const bb = (b.artist||"").toLowerCase();
      if (aa !== bb) return aa.localeCompare(bb);
      const at = (a.title||"").toLowerCase();
      const bt = (b.title||"").toLowerCase();
      return at.localeCompare(bt);
    });
  }

  function sanitizeSong(s){
    const out = {
      artist: String(s.artist||""),
      title: String(s.title||""),
      duration: parseDurationFlexible(s.duration||""),
      year: String(s.year||""),
      style: normArray(s.style||[]),
      category: String(s.category||""),
      cover: String(s.cover||"img/default-cover.jpg"),
      addedAt: s.addedAt ? String(s.addedAt) : new Date().toISOString()
    };
    // merge styles into master list
    out.style.forEach(st => {
      if (st && !masterStyles.some(x=>x.toLowerCase()===st.toLowerCase())) masterStyles.push(st);
    });
    masterStyles = masterStyles.filter(Boolean).sort((a,b)=>a.toLowerCase().localeCompare(b.toLowerCase()));
    return out;
  }

  // --- Load JS file text and evaluate inside Function() ---
  function parseSongsFromJs(code, varName){
    const fn = new Function(code + `; return (typeof ${varName} !== "undefined") ? ${varName} : null;`);
    const arr = fn();
    if (!arr || !Array.isArray(arr)) throw new Error(`Could not find array variable: ${varName}`);
    return arr.map(sanitizeSong);
  }

  async function loadFromSite(){
    const url = "songs/" + state.fileName;
    setStatus(`Loading from site: <code>${escapeHtml(url)}</code> …`);
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(`Fetch failed (${res.status}) for ${url}`);
    const code = await res.text();
    state.songs = parseSongsFromJs(code, state.varName);
    sortSongs();
    state.selectedIndex = -1;
    renderList();
    clearEditor();
    setStatus(`Loaded <b>${state.fileName}</b> (${state.songs.length} songs).`);
  }

  function loadFromLocalFile(file){
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const code = String(reader.result||"");
        state.songs = parseSongsFromJs(code, state.varName);
        sortSongs();
        state.selectedIndex = -1;
        renderList();
        clearEditor();
        setStatus(`Imported local <b>${escapeHtml(file.name)}</b> → ${state.songs.length} songs.`);
      }catch(e){
        setStatus(`Import error: ${escapeHtml(e.message||String(e))}`, true);
      }
    };
    reader.readAsText(file);
  }

  function renderList(){
    const box = $("songsList");
    const q = $("listSearch").value.toLowerCase().trim();

    const filtered = state.songs
      .map((s, idx) => ({s, idx}))
      .filter(({s})=>{
        if (!q) return true;
        const hay = `${s.artist} ${s.title} ${s.year} ${s.category} ${(s.style||[]).join(" ")} ${s.duration}`.toLowerCase();
        return hay.includes(q);
      });

    box.innerHTML = filtered.map(({s, idx})=>{
      const active = idx === state.selectedIndex ? " active" : "";
      const meta = [s.year, s.category, s.duration].filter(Boolean).join(" • ");
      return `
        <div class="song-row${active}" data-idx="${idx}">
          <div class="t">${escapeHtml(s.title || "(untitled)")}</div>
          <div class="a">${escapeHtml(s.artist || "(unknown artist)")}</div>
          <div class="m">${escapeHtml(meta)}</div>
        </div>
      `;
    }).join("");

    box.querySelectorAll(".song-row").forEach(row=>{
      row.addEventListener("click", ()=>{
        const idx = parseInt(row.getAttribute("data-idx"), 10);
        selectSong(idx);
      });
    });
  }

  function clearEditor(){
    $("fTitle").value = "";
    $("fArtist").value = "";
    $("fYear").value = "";
    $("fCategory").value = decadeOrder[0];
    $("fDuration").value = "";
    $("fMin").value = "0";
    $("fSec").value = "0";
    $("fAddedAt").value = "";
    $("fCover").value = "img/default-cover.jpg";
    $("coverImg").src = "img/default-cover.jpg";
    state.coverBlob = null;
    $("downloadCoverBtn").disabled = true;
    $("suggestedCoverName").textContent = "Artist - Title.jpg";
    renderStyles([]);
  }

  function renderStyles(selectedArr){
    const selected = new Set((selectedArr||[]).map(s=>String(s)));
    // ensure master includes any selected
    (selectedArr||[]).forEach(st=>{
      if (st && !masterStyles.some(x=>x.toLowerCase()===String(st).toLowerCase())) masterStyles.push(String(st));
    });
    masterStyles = masterStyles.filter(Boolean).sort((a,b)=>a.toLowerCase().localeCompare(b.toLowerCase()));

    const box = $("styleChips");
    box.innerHTML = masterStyles.map(st => {
      const checked = selected.has(st) ? "checked" : "";
      return `
        <label class="chip">
          <input type="checkbox" class="styleCheck" value="${escapeHtml(st)}" ${checked}>
          ${escapeHtml(st)}
        </label>
      `;
    }).join("");
  }

  function selectSong(idx){
    state.selectedIndex = idx;
    renderList();
    const s = state.songs[idx];
    if (!s) return;

    $("fTitle").value = s.title || "";
    $("fArtist").value = s.artist || "";
    $("fYear").value = s.year || "";
    $("fCategory").value = s.category || decadeOrder[0];

    const dur = parseDurationFlexible(s.duration || "");
    $("fDuration").value = dur;
    const m = dur.match(/^(\d{2}):(\d{2})$/);
    if (m){
      $("fMin").value = String(parseInt(m[1],10));
      $("fSec").value = String(parseInt(m[2],10));
    }else{
      $("fMin").value = "0";
      $("fSec").value = "0";
    }

    $("fAddedAt").value = s.addedAt || "";
    $("fCover").value = s.cover || "img/default-cover.jpg";

    $("coverImg").src = s.cover || "img/default-cover.jpg";
    $("coverImg").onerror = function(){
      this.onerror = null;
      this.src = "img/default-cover.jpg";
    };

    const suggested = slugCoverName(s.artist, s.title);
    $("suggestedCoverName").textContent = suggested;

    renderStyles(s.style || []);
  }

  function gatherEditorSong(){
    const title = $("fTitle").value.trim();
    const artist = $("fArtist").value.trim();
    const year = String($("fYear").value || "").trim();
    const category = $("fCategory").value || "";
    const cover = $("fCover").value.trim() || "img/default-cover.jpg";

    // duration: prefer dropdown if user changed it (kept synced)
    let duration = $("fDuration").value.trim();
    duration = parseDurationFlexible(duration);
    if (!duration){
      duration = durationFromPickers();
      if (duration === "00:00") duration = "";
    }

    const addedAt = $("fAddedAt").value.trim() || new Date().toISOString();

    const styles = Array.from(document.querySelectorAll(".styleCheck:checked"))
      .map(x => x.value)
      .map(x => String(x).trim())
      .filter(Boolean);

    return sanitizeSong({
      artist, title, year, category, style: styles, duration, cover, addedAt
    });
  }

  function saveSong(){
    if (state.selectedIndex < 0){
      setStatus("No song selected. Use <b>Add Song</b> first, then edit.", true);
      return;
    }
    const updated = gatherEditorSong();
    if (!updated.title || !updated.artist){
      setStatus("Please fill at least <b>Title</b> and <b>Artist</b>.", true);
      return;
    }
    state.songs[state.selectedIndex] = updated;
    sortSongs();
    // after sort, reselect by identity (artist+title)
    const key = (updated.artist+"||"+updated.title).toLowerCase();
    state.selectedIndex = state.songs.findIndex(s => (s.artist+"||"+s.title).toLowerCase() === key);
    renderList();
    selectSong(state.selectedIndex);
    setStatus("Saved (local). Don’t forget to <b>Export</b> and upload to GitHub.");
  }

  function addNewSong(){
    const now = new Date().toISOString();
    const s = sanitizeSong({
      artist: "",
      title: "",
      duration: "",
      year: "",
      style: [],
      category: "80s Music",
      cover: "img/default-cover.jpg",
      addedAt: now
    });
    state.songs.push(s);
    sortSongs();
    // select the blank one (last matching blank)
    state.selectedIndex = state.songs.findIndex(x => x.addedAt === now);
    renderList();
    selectSong(state.selectedIndex);
    setStatus("New song added (local). Fill fields then Save.");
  }

  function deleteSong(){
    if (state.selectedIndex < 0) return;
    const s = state.songs[state.selectedIndex];
    if (!confirm(`Delete:\n${s.artist} – ${s.title} ?`)) return;
    state.songs.splice(state.selectedIndex, 1);
    state.selectedIndex = -1;
    renderList();
    clearEditor();
    setStatus("Deleted (local). Export to apply in GitHub.");
  }

  function exportJs(){
    sortSongs();
    const data = JSON.stringify(state.songs, null, 2);
    const js = `const ${state.varName} = ${data};\n`;

    const blob = new Blob([js], { type: "application/javascript;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = state.fileName;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setStatus(`Exported <b>${state.fileName}</b>. Upload it back to <code>songs/${state.fileName}</code> on GitHub.`);
  }

  // Cover: preview + download renamed
  function onCoverPicked(file){
    if (!file) return;
    const url = URL.createObjectURL(file);
    $("coverImg").src = url;
    state.coverBlob = file;

    const suggested = slugCoverName($("fArtist").value.trim(), $("fTitle").value.trim());
    $("suggestedCoverName").textContent = suggested;

    $("downloadCoverBtn").disabled = false;
  }

  function downloadCover(){
    if (!state.coverBlob) return;
    const suggested = slugCoverName($("fArtist").value.trim(), $("fTitle").value.trim());
    const blob = state.coverBlob;
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = suggested;
    document.body.appendChild(a);
    a.click();
    a.remove();

    // also auto-fill cover path
    $("fCover").value = "img/" + suggested;
    setStatus(`Cover downloaded as <b>${escapeHtml(suggested)}</b>. Put it in <code>img/</code> and upload to GitHub.`);
  }

  // CSV bulk helpers
  function parseCSV(text){
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;
    for (let i=0; i<text.length; i++){
      const ch = text[i];
      const next = text[i+1];
      if (ch === '"' && inQuotes && next === '"'){ cur += '"'; i++; continue; }
      if (ch === '"'){ inQuotes = !inQuotes; continue; }
      if (ch === ',' && !inQuotes){ row.push(cur); cur = ""; continue; }
      if ((ch === '\n' || ch === '\r') && !inQuotes){
        if (ch === '\r' && next === '\n') i++;
        row.push(cur);
        if (row.some(v => String(v).trim() !== "")) rows.push(row);
        row = []; cur = "";
        continue;
      }
      cur += ch;
    }
    row.push(cur);
    if (row.some(v => String(v).trim() !== "")) rows.push(row);
    return rows;
  }

  function importCSVReplace(){
    const text = $("csvBox").value.trim();
    if (!text) return setStatus("CSV box is empty.", true);

    try{
      const rows = parseCSV(text);
      if (rows.length < 2) throw new Error("CSV needs header + at least one row.");

      const headers = rows[0].map(h => String(h||"").trim().toLowerCase());
      const objs = rows.slice(1).map(r => {
        const o = {};
        headers.forEach((h,i)=>o[h] = (r[i] ?? "").trim());
        return o;
      });

      state.songs = objs.map(o => sanitizeSong({
        artist: o.artist || "",
        title: o.title || "",
        year: o.year || "",
        category: o.category || "",
        style: o.style || "",
        duration: o.duration || "",
        cover: o.cover || "img/default-cover.jpg",
        addedAt: o.addedat || o.addedAt || ""
      }));

      sortSongs();
      state.selectedIndex = -1;
      renderList();
      clearEditor();
      setStatus(`CSV imported. Current file now has <b>${state.songs.length}</b> songs. Export to save.`);
    }catch(e){
      setStatus(`CSV import error: ${escapeHtml(e.message||String(e))}`, true);
    }
  }

  function exportCSV(){
    sortSongs();
    const headers = ["artist","title","year","category","style","duration","cover","addedAt"];
    const lines = [headers.join(",")];

    for (const s of state.songs){
      const row = [
        s.artist, s.title, s.year, s.category,
        (s.style||[]).join(" | "),
        s.duration, s.cover, s.addedAt
      ].map(v=>{
        const x = String(v ?? "");
        if (x.includes(",") || x.includes('"') || x.includes("\n")){
          return `"${x.replaceAll('"','""')}"`;
        }
        return x;
      });
      lines.push(row.join(","));
    }

    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `songs_${state.letter}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setStatus("CSV exported.");
  }

  // ---- Wire up UI ----
  function updateLetter(letter){
    state.letter = letter;
    state.varName = computeVarName(letter);
    state.fileName = computeFileName(letter);
    $("sitePath").textContent = "songs/" + state.fileName;
    setStatus(`Selected <b>${state.fileName}</b> (${state.varName}). Load it from site or import local.`);
    state.songs = [];
    state.selectedIndex = -1;
    $("songsList").innerHTML = "";
    clearEditor();
  }

  function syncDurationFromPickers(){
    const d = durationFromPickers();
    $("fDuration").value = d;
  }

  // Init page
  fillLetterSelect();
  fillDecades();
  fillDurationPickers();

  // default letter = A
  updateLetter("A");

  $("letterSelect").addEventListener("change", (e)=> updateLetter(e.target.value));
  $("loadFromSiteBtn").addEventListener("click", async ()=>{
    try{ await loadFromSite(); }
    catch(e){ setStatus(`Load error: ${escapeHtml(e.message||String(e))}`, true); }
  });

  $("localFile").addEventListener("change", (e)=>{
    const f = e.target.files && e.target.files[0];
    if (f) loadFromLocalFile(f);
  });

  $("listSearch").addEventListener("input", renderList);
  $("addNewBtn").addEventListener("click", addNewSong);

  $("saveBtn").addEventListener("click", saveSong);
  $("deleteBtn").addEventListener("click", deleteSong);

  $("exportBtn").addEventListener("click", exportJs);

  $("addStyleBtn").addEventListener("click", ()=>{
    const st = $("newStyle").value.trim();
    if (!st) return;
    if (!masterStyles.some(x=>x.toLowerCase()===st.toLowerCase())) masterStyles.push(st);
    masterStyles = masterStyles.filter(Boolean).sort((a,b)=>a.toLowerCase().localeCompare(b.toLowerCase()));
    $("newStyle").value = "";
    // keep selection
    const selected = Array.from(document.querySelectorAll(".styleCheck:checked")).map(x=>x.value);
    renderStyles(selected);
    setStatus(`Style added: <b>${escapeHtml(st)}</b>. (Saved to this session)`);
  });

  $("fMin").addEventListener("change", syncDurationFromPickers);
  $("fSec").addEventListener("change", syncDurationFromPickers);

  $("fTitle").addEventListener("input", ()=>{
    const suggested = slugCoverName($("fArtist").value.trim(), $("fTitle").value.trim());
    $("suggestedCoverName").textContent = suggested;
  });
  $("fArtist").addEventListener("input", ()=>{
    const suggested = slugCoverName($("fArtist").value.trim(), $("fTitle").value.trim());
    $("suggestedCoverName").textContent = suggested;
  });

  $("coverFile").addEventListener("change", (e)=> onCoverPicked(e.target.files && e.target.files[0]));
  $("downloadCoverBtn").addEventListener("click", downloadCover);

  $("importCsvBtn").addEventListener("click", ()=>{
    if (!confirm("This will REPLACE the current file content in memory. Continue?")) return;
    importCSVReplace();
  });
  $("exportCsvBtn").addEventListener("click", exportCSV);
</script>
</body>
</html>
