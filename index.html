<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cugell – Songs</title>

  <style>
    body{
      margin:0; padding:0;
      font-family:"Trebuchet MS", Arial, sans-serif;
      background: radial-gradient(circle at top, #55415f 0, #1c1024 45%, #07050b 100%);
      color:#f7f1e3;
    }

    .container{
      max-width: 1300px;
      margin: 26px auto 50px;
      padding: 18px;
      background: rgba(20,12,26,.55);
      border-radius: 18px;
      box-shadow: 0 0 25px rgba(0,0,0,0.65);
      border: 1px solid rgba(231,207,154,.22);
      backdrop-filter: blur(6px);
    }

    .top-nav{
      display:flex;
      justify-content:center;
      gap:12px;
      margin-bottom:14px;
      flex-wrap:wrap;
    }
    .top-nav a{
      text-decoration:none;
      color:#f7f1e3;
      font-size:14px;
      padding:7px 14px;
      border-radius:999px;
      border:1px solid rgba(231,207,154,.35);
      background: rgba(10,6,14,.35);
    }
    .top-nav a.active{
      background: linear-gradient(180deg, rgba(241,228,196,.95), rgba(199,155,83,.82));
      color:#2a1540;
      font-weight:900;
      border-color: rgba(231,207,154,.50);
    }

    .page-header{
      display:grid;
      grid-template-columns: 220px 1fr;
      gap:18px;
      align-items:center;
      margin: 8px 0 14px;
    }
    .header-image{
      width:100%;
      max-width:220px;
      aspect-ratio:1/1;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(231,207,154,.30);
      background: rgba(10,6,14,.35);
      box-shadow: 0 10px 18px rgba(0,0,0,.35);
    }
    .header-image img{ width:100%; height:100%; object-fit:cover; display:block; }

    .header-right{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .header-title{
      font-size: 28px;
      letter-spacing:1px;
      margin:0;
    }

    /* ---- Recent block ---- */
    .recent-block{
      border-radius:16px;
      border:1px solid rgba(231,207,154,.18);
      background: rgba(0,0,0,.14);
      box-shadow: 0 10px 18px rgba(0,0,0,.22);
      overflow:hidden;
      max-width: 640px;
    }
    .recent-label{
      text-align:center;
      padding:10px 12px;
      font-weight:900;
      letter-spacing:1px;
      font-size:12px;
      color:#2a1540;
      border-bottom:1px solid rgba(231,207,154,.18);
      background:
        radial-gradient(200px 60px at 30% 20%, rgba(255,255,255,.40), transparent 60%),
        linear-gradient(180deg, rgba(241,228,196,.98), rgba(231,207,154,.95) 40%, rgba(199,155,83,.88));
      position:relative;
    }
    .recent-label:before{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='240' height='120'%3E%3Cfilter id='p'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='240' height='120' filter='url(%23p)' opacity='.22'/%3E%3C/svg%3E");
      mix-blend-mode:multiply;
      opacity:.55;
    }
    .recent-strip{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      padding:10px;
    }
    @media (max-width: 900px){
      .recent-strip{ grid-template-columns: 1fr; }
    }

    .mini-card{
      display:grid;
      grid-template-columns: 58px 1fr;
      gap:10px;
      align-items:center;
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(231,207,154,.16);
      background: rgba(83,54,96,.22);
      box-shadow: 0 8px 14px rgba(0,0,0,.22);
    }
    .mini-cover{
      width:58px; height:58px;
      border-radius:12px;
      overflow:hidden;
      border:1px solid rgba(231,207,154,.24);
      background: rgba(10,6,14,.35);
    }
    .mini-cover img{ width:100%; height:100%; object-fit:cover; display:block; }
    .mini-title{
      font-weight:900;
      font-size:13px;
      line-height:1.1;
    }
    .mini-artist{
      font-size:13px;
      color:#f7f1e3;
      font-weight:700;
      opacity:.92;
      margin-top:3px;
    }
    .mini-meta{
      margin-top:3px;
      font-size:12px;
      color: rgba(247,241,227,.80);
    }

    @media (max-width: 700px){
      .page-header{ grid-template-columns: 1fr; text-align:center; }
      .header-image{ margin: 0 auto; }
      .recent-block{ margin: 0 auto; }
    }

    /* ---- Controls ---- */
    .controls{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin: 14px 0 14px;
    }
    .search-row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .search-row input{
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(231,207,154,.30);
      background: rgba(10,6,14,.35);
      color:#f7f1e3;
      font-size:14px;
      flex: 1 1 260px;
      outline:none;
    }

    .filter-bar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      cursor:pointer;
      user-select:none;
      border-radius:999px;
      padding:8px 12px;
      border:1px solid rgba(231,207,154,.26);
      background: rgba(10,6,14,.28);
      color:#f7f1e3;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .pill strong{ font-weight:900; }
    .pill .count{
      font-size:12px;
      opacity:.85;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(231,207,154,.18);
      background: rgba(0,0,0,.15);
    }
    .pill.clear{
      border-color: rgba(255,255,255,.20);
      background: rgba(255,255,255,.08);
    }

    /* Popover */
    .popover{
      position:relative;
    }
    .popover-panel{
      position:absolute;
      top: 44px;
      left:0;
      z-index:50;
      min-width: 280px;
      max-width: min(720px, 92vw);
      max-height: 360px;
      overflow:auto;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(231,207,154,.22);
      background: rgba(20,12,26,.92);
      box-shadow: 0 18px 30px rgba(0,0,0,.55);
      display:none;
    }
    .popover.open .popover-panel{ display:block; }
    .panel-title{
      font-weight:900;
      font-size:12px;
      letter-spacing:1px;
      color: rgba(231,207,154,.95);
      margin: 2px 0 10px;
      text-transform: uppercase;
    }
    .checks{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .checks label{
      display:inline-flex;
      align-items:center;
      gap:7px;
      border-radius:999px;
      padding:6px 10px;
      border:1px solid rgba(231,207,154,.20);
      background: rgba(83,54,96,.16);
      cursor:pointer;
      font-size:13px;
    }
    .checks input{ margin:0; }

    .counter{
      font-size:13px;
      color: rgba(247,241,227,.82);
      margin: 6px 0 10px;
    }

    /* ---- Grid cards ---- */
    .grid{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 15px;
    }
    @media (max-width: 1200px){ .grid{ grid-template-columns: repeat(4,1fr); } }
    @media (max-width: 1000px){ .grid{ grid-template-columns: repeat(3,1fr); } }
    @media (max-width: 700px){ .grid{ grid-template-columns: repeat(2,1fr); } }
    @media (max-width: 450px){ .grid{ grid-template-columns: repeat(1,1fr); } }

    .song{
      border-radius: 16px;
      border: 1px solid rgba(231,207,154,.22);
      background:
        radial-gradient(220px 120px at 30% 10%, rgba(231,207,154,.10), transparent 60%),
        linear-gradient(180deg, rgba(83,54,96,.26), rgba(10,6,14,.22));
      box-shadow: 0 12px 22px rgba(0,0,0,.35);
      overflow:hidden;
    }

    .song-cover{
      width:100%;
      aspect-ratio:1/1;
      background: rgba(0,0,0,.18);
      border-bottom: 1px solid rgba(231,207,154,.18);
      position:relative;
    }
    .song-cover img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      filter: saturate(1.05) contrast(1.05);
    }
    .song-cover:after{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      box-shadow: inset 0 0 0 2px rgba(0,0,0,.15);
    }

    .song-body{
      padding: 10px 12px 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .song-title{
      font-weight:900;
      font-size:15px;
      line-height:1.15;
    }
    .song-artist{
      font-size:14px;
      font-weight:800;
      color:#f7f1e3;
      opacity:.95;
      margin-top:-4px;
    }

    .sep{
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(231,207,154,.28), transparent);
      margin: 2px 0;
    }

    .meta-row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:12px;
      color: rgba(247,241,227,.86);
      align-items:center;
    }

    .ribbon{
      display:inline-flex;
      align-items:center;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(231,207,154,.26);
      background:
        radial-gradient(120px 30px at 20% 20%, rgba(255,255,255,.28), transparent 60%),
        linear-gradient(180deg, rgba(241,228,196,.95), rgba(199,155,83,.82));
      color:#2a1540;
      font-weight:900;
      letter-spacing:.4px;
    }

    .styles{
      font-size:12px;
      color: rgba(247,241,227,.85);
      line-height:1.35;
    }

    .loading{
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(231,207,154,.22);
      background: rgba(0,0,0,.18);
      margin: 10px 0 14px;
    }
    .error{
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,120,120,.35);
      background: rgba(255,80,80,.10);
      margin: 10px 0 14px;
    }
  </style>
</head>

<body>
  <div class="container">

    <nav class="top-nav">
      <a href="index.html" class="active">Songs</a>
      <a href="soundtracks.html">Soundtracks</a>
    </nav>

    <div class="page-header">
      <div class="header-image">
        <img src="img/header.png" alt="Songs">
      </div>

      <div class="header-right">
        <h1 class="header-title">Cugell’s Songs</h1>

        <div class="recent-block">
          <div class="recent-label">NEW RELEASES</div>
          <div class="recent-strip" id="recentStrip"></div>
        </div>
      </div>
    </div>

    <div class="controls">
      <div class="search-row">
        <input type="text" id="search" placeholder="Search by title, artist, year, genre…" />
      </div>

      <div class="filter-bar">
        <div class="popover" id="decadePopover">
          <div class="pill" id="decadeBtn">
            <strong>Decades</strong>
            <span class="count" id="decadeCount">0</span>
          </div>
          <div class="popover-panel" role="dialog" aria-label="Decades">
            <div class="panel-title">Decades</div>
            <div class="checks" id="decadeChecks"></div>
          </div>
        </div>

        <div class="popover" id="genrePopover">
          <div class="pill" id="genreBtn">
            <strong>Genres</strong>
            <span class="count" id="genreCount">0</span>
          </div>
          <div class="popover-panel" role="dialog" aria-label="Genres">
            <div class="panel-title">Genres</div>
            <div class="checks" id="genreChecks"></div>
          </div>
        </div>

        <div class="pill clear" id="clearBtn">Clear filters</div>
      </div>
    </div>

    <div id="status" class="loading">Loading songs from Google Sheets…</div>

    <div class="counter" id="counter"></div>
    <div id="grid" class="grid"></div>
  </div>

<script>
  // =========================================================
  // 1) Put your published CSV URL here
  // =========================================================
  const SHEET_CSV_URL = "PUT_YOUR_CSV_URL_HERE";

  // Expected headers:
  // artist | title | year | category | style | duration | cover | addedAt

  // ------------------ utilities ------------------
  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function normArray(val){
    if (!val) return [];
    if (Array.isArray(val)) return val;
    // styles in sheet: Pop|Disco (or commas)
    return String(val).split(/[\|,]/g).map(v => v.trim()).filter(Boolean);
  }

  function parseDateFlexible(s){
    const str = String(s || "").trim();
    if (!str) return null;

    // ISO?
    const iso = Date.parse(str);
    if (!Number.isNaN(iso)) return new Date(iso);

    // dd/mm/yyyy (like your sample: 21/01/2026)
    const m = str.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if (m){
      const dd = parseInt(m[1],10);
      const mm = parseInt(m[2],10);
      const yyyy = parseInt(m[3],10);
      return new Date(Date.UTC(yyyy, mm-1, dd, 0,0,0));
    }

    return null;
  }

  // Robust CSV parser (quotes supported) + auto delimiter
  function parseCSV(text){
    const rows=[];
    let row=[];
    let cur="";
    let inQuotes=false;

    const sample = text.split(/\r?\n/).slice(0, 6).join("\n");
    const delim = (sample.match(/;/g) || []).length > (sample.match(/,/g) || []).length ? ";" : ",";

    for (let i=0; i<text.length; i++){
      const ch=text[i], next=text[i+1];

      if (ch === '"'){
        if (inQuotes && next === '"'){ cur += '"'; i++; }
        else inQuotes = !inQuotes;
        continue;
      }

      if (!inQuotes && ch === delim){
        row.push(cur); cur=""; continue;
      }

      if (!inQuotes && (ch === "\n" || ch === "\r")){
        if (ch === "\r" && next === "\n") i++;
        row.push(cur);
        rows.push(row);
        row=[]; cur="";
        continue;
      }

      cur += ch;
    }

    if (cur.length || row.length){
      row.push(cur);
      rows.push(row);
    }

    return rows.map(r => r.map(c => (c ?? "").trim()));
  }

  function mapRow(headers, row){
    const obj = {};
    headers.forEach((h, i) => obj[h] = (row[i] ?? "").trim());

    const cover = obj.cover || "img/default-cover.jpg";
    return {
      artist: obj.artist || "",
      title: obj.title || "",
      year: obj.year || "",
      category: obj.category || "",
      style: normArray(obj.style || ""),
      duration: obj.duration || "",
      cover: cover || "img/default-cover.jpg",
      addedAt: obj.addedAt || ""
    };
  }

  async function loadSongsFromSheet(){
    const res = await fetch(SHEET_CSV_URL, { cache: "no-store" });
    if (!res.ok) throw new Error("Failed to fetch CSV. Check publish settings / URL.");
    const csvText = await res.text();

    const table = parseCSV(csvText);
    if (table.length < 2) return [];

    const headers = table[0].map(h => (h || "").trim().toLowerCase());
    const songs = [];

    for (let i=1; i<table.length; i++){
      const row = table[i];
      if (!row.some(c => String(c||"").trim())) continue;
      songs.push(mapRow(headers, row));
    }
    return songs;
  }

  // ------------------ state ------------------
  const state = {
    songs: [],
    selectedDecades: new Set(),
    selectedGenres: new Set()
  };

  // ------------------ UI build ------------------
  const decadeOrder = ["60s Music","70s Music","80s Music","90s Music","2000s Music","2010s Music","2020s Music","Mixed Years"];

  function buildDecades(){
    const box = document.getElementById("decadeChecks");
    box.innerHTML = decadeOrder.map(d => `
      <label>
        <input type="checkbox" class="decadeCheck" value="${escapeHtml(d)}">
        ${escapeHtml(d.replace(" Music","").replace("2000s","2000s").replace("Mixed Years","Mixed"))}
      </label>
    `).join("");

    box.querySelectorAll("input").forEach(cb => {
      cb.addEventListener("change", () => {
        if (cb.checked) state.selectedDecades.add(cb.value);
        else state.selectedDecades.delete(cb.value);
        updateCounts();
        renderGrid();
      });
    });
  }

  function buildGenres(){
    const set = new Set();
    state.songs.forEach(s => s.style.forEach(g => set.add(g)));

    const genres = Array.from(set).sort((a,b)=>a.toLowerCase().localeCompare(b.toLowerCase()));
    const box = document.getElementById("genreChecks");

    box.innerHTML = genres.map(g => `
      <label>
        <input type="checkbox" class="genreCheck" value="${escapeHtml(g)}">
        ${escapeHtml(g)}
      </label>
    `).join("");

    box.querySelectorAll("input").forEach(cb => {
      cb.addEventListener("change", () => {
        if (cb.checked) state.selectedGenres.add(cb.value);
        else state.selectedGenres.delete(cb.value);
        updateCounts();
        renderGrid();
      });
    });
  }

  function updateCounts(){
    document.getElementById("decadeCount").textContent = String(state.selectedDecades.size);
    document.getElementById("genreCount").textContent = String(state.selectedGenres.size);
  }

  function openClosePopover(pop, open){
    if (open) pop.classList.add("open");
    else pop.classList.remove("open");
  }

  function bindPopovers(){
    const decadePop = document.getElementById("decadePopover");
    const genrePop  = document.getElementById("genrePopover");
    document.getElementById("decadeBtn").addEventListener("click", () => {
      const isOpen = decadePop.classList.contains("open");
      openClosePopover(decadePop, !isOpen);
      openClosePopover(genrePop, false);
    });
    document.getElementById("genreBtn").addEventListener("click", () => {
      const isOpen = genrePop.classList.contains("open");
      openClosePopover(genrePop, !isOpen);
      openClosePopover(decadePop, false);
    });

    document.addEventListener("click", (e) => {
      if (!decadePop.contains(e.target)) openClosePopover(decadePop, false);
      if (!genrePop.contains(e.target)) openClosePopover(genrePop, false);
    });
  }

  function clearFilters(){
    state.selectedDecades.clear();
    state.selectedGenres.clear();
    document.querySelectorAll(".decadeCheck, .genreCheck").forEach(cb => cb.checked = false);
    updateCounts();
    renderGrid();
  }

  // ------------------ filtering + render ------------------
  function matchesFilters(song){
    const search = document.getElementById("search").value.toLowerCase().trim();

    const searchTarget = (
      (song.title||"") + " " +
      (song.artist||"") + " " +
      (song.year||"") + " " +
      (song.category||"") + " " +
      (song.style||[]).join(" ") + " " +
      (song.duration||"")
    ).toLowerCase();

    const okSearch = !search || searchTarget.includes(search);

    const okDecade =
      state.selectedDecades.size === 0 ||
      state.selectedDecades.has(song.category);

    // AND logic: must contain all selected genres
    const okGenres =
      state.selectedGenres.size === 0 ||
      Array.from(state.selectedGenres).every(g => (song.style||[]).includes(g));

    return okSearch && okDecade && okGenres;
  }

  function renderGrid(){
    const grid = document.getElementById("grid");
    const counter = document.getElementById("counter");

    const filtered = state.songs.filter(matchesFilters);

    grid.innerHTML = "";
    filtered.forEach(song => {
      const cover = song.cover || "img/default-cover.jpg";
      const styles = (song.style||[]).join(", ");

      const yearDecade = [
        song.year ? escapeHtml(song.year) : "",
        song.category ? escapeHtml(song.category) : ""
      ].filter(Boolean).join(" • ");

      const dur = song.duration ? escapeHtml(song.duration) : "";

      const card = document.createElement("div");
      card.className = "song";
      card.innerHTML = `
        <div class="song-cover">
          <img src="${escapeHtml(cover)}" alt="${escapeHtml(song.title)}"
               onerror="this.onerror=null;this.src='img/default-cover.jpg';">
        </div>
        <div class="song-body">
          <div class="song-title">${escapeHtml(song.title)}</div>
          <div class="song-artist">${escapeHtml(song.artist)}</div>

          <div class="sep"></div>

          <div class="meta-row">
            <span class="ribbon">${yearDecade || "&nbsp;"}</span>
            <span>${dur ? "⏱ " + dur : "&nbsp;"}</span>
          </div>

          ${styles ? `<div class="sep"></div><div class="styles">${escapeHtml(styles)}</div>` : ""}
        </div>
      `;
      grid.appendChild(card);
    });

    counter.textContent = `${filtered.length} song(s) shown`;
  }

  function renderRecent(){
    const strip = document.getElementById("recentStrip");

    // sort by addedAt desc (supports dd/mm/yyyy or ISO)
    const withDate = state.songs
      .map(s => ({...s, __d: parseDateFlexible(s.addedAt)}))
      .filter(s => s.__d);

    withDate.sort((a,b) => b.__d - a.__d);

    const recent = withDate.slice(0,3);
    if (!recent.length){
      strip.innerHTML = `<div class="mini-card"><div>⚠ No "addedAt" dates found in sheet.</div></div>`;
      return;
    }

    strip.innerHTML = recent.map(s => {
      const cover = s.cover || "img/default-cover.jpg";
      const dateLabel = s.__d ? s.__d.toISOString().slice(0,10) : "";
      const yd = [s.year, s.category].filter(Boolean).join(" • ");
      return `
        <div class="mini-card">
          <div class="mini-cover">
            <img src="${escapeHtml(cover)}" alt="${escapeHtml(s.title)}"
                 onerror="this.onerror=null;this.src='img/default-cover.jpg';">
          </div>
          <div>
            <div class="mini-title">${escapeHtml(s.title)}</div>
            <div class="mini-artist">${escapeHtml(s.artist)}</div>
            <div class="mini-meta">${escapeHtml(yd)}${yd ? " • " : ""}${escapeHtml(dateLabel)}</div>
          </div>
        </div>
      `;
    }).join("");
  }

  // ------------------ init ------------------
  async function init(){
    buildDecades();
    bindPopovers();

    document.getElementById("clearBtn").addEventListener("click", clearFilters);
    document.getElementById("search").addEventListener("input", renderGrid);

    const status = document.getElementById("status");

    try{
      if (!SHEET_CSV_URL || SHEET_CSV_URL.includes("https://docs.google.com/spreadsheets/d/e/2PACX-1vQmxQ841UMZvix40EVc724ODuc9DY5L5dnPGPUGABnj15H5Mm4y-0ik1hNvRM5444PL5MpClNXfP0FG/pub?output=csv")){
        status.className = "error";
        status.textContent = "Missing SHEET_CSV_URL. Replace it with your Google Sheets CSV publish link.";
        return;
      }

      const songs = await loadSongsFromSheet();
      state.songs = songs;

      status.remove();

      buildGenres();
      updateCounts();
      renderRecent();
      renderGrid();
    }catch(e){
      console.error(e);
      status.className = "error";
      status.textContent = "Error loading Google Sheet CSV. Check that the sheet is published as CSV and public.";
    }
  }

  init();
</script>
</body>
</html>
