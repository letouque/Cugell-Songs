<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cugell – Songs</title>

  <style>
    :root{
      /* Cugell-ish palette */
      --bg0:#050308;
      --bg1:#1b0f24;
      --bg2:#2a1540;

      --card0:#2a1840;
      --card1:#1f102f;

      --ink:#f7f1e3;
      --ink2:#d9cceb;
      --muted:#bcaad0;

      --gold:#c79b53;
      --gold2:#e7cf9a;

      --line: rgba(231, 207, 154, .22);
      --stroke: rgba(199,155,83,.55);

      --shadow: 0 18px 40px rgba(0,0,0,.55);
      --shadow2: 0 10px 22px rgba(0,0,0,.45);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      color:var(--ink);
      font-family: "Trebuchet MS", Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(231,207,154,.10), transparent 60%),
        radial-gradient(900px 500px at 80% 10%, rgba(199,155,83,.09), transparent 55%),
        radial-gradient(circle at top, #5a3b73 0, var(--bg1) 36%, var(--bg0) 100%);
    }

    /* subtle grain */
    body:before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.12'/%3E%3C/svg%3E");
      mix-blend-mode: overlay;
      opacity:.18;
    }

    .wrap{
      max-width: 1400px;
      margin: 22px auto 60px;
      padding: 0 16px;
      position:relative;
    }

    /* top nav */
    .top-nav{
      display:flex;
      justify-content:center;
      gap:14px;
      flex-wrap:wrap;
      margin: 8px 0 18px;
    }
    .top-nav a{
      text-decoration:none;
      color:var(--ink);
      font-size:14px;
      padding: 8px 14px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(43,25,66,.75), rgba(20,10,30,.75));
      box-shadow: 0 6px 14px rgba(0,0,0,.35);
    }
    .top-nav a.active{
      background: linear-gradient(180deg, rgba(199,155,83,.95), rgba(231,207,154,.75));
      color:#1c1024;
      font-weight:700;
      border-color: rgba(231,207,154,.85);
    }

    /* header card */
    .hero{
      display:grid;
      grid-template-columns: 220px 1fr;
      gap:16px;
      align-items:stretch;
      padding: 16px;
      border-radius: var(--radius);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      background:
        radial-gradient(700px 420px at 20% 20%, rgba(231,207,154,.12), transparent 55%),
        linear-gradient(160deg, rgba(58,31,92,.85), rgba(26,12,40,.88));
      position:relative;
      overflow:hidden;
    }
    .hero:after{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      background: linear-gradient(90deg, rgba(231,207,154,.10), transparent 30%, transparent 70%, rgba(199,155,83,.10));
      opacity:.55;
    }

    .hero-img{
      width:100%;
      max-width:220px;
      aspect-ratio: 1 / 1;
      border-radius: 16px;
      overflow:hidden;
      border: 1px solid rgba(231,207,154,.35);
      background: rgba(0,0,0,.25);
      box-shadow: var(--shadow2);
      position:relative;
      z-index:1;
    }
    .hero-img img{
      width:100%; height:100%;
      object-fit: cover;
      display:block;
    }

    .hero-right{
      position:relative;
      z-index:1;
      display:flex;
      flex-direction:column;
      gap: 12px;
      min-width:0;
    }

    .hero-title{
      margin: 2px 0 0;
      font-size: 30px;
      letter-spacing: .8px;
      text-shadow: 0 2px 10px rgba(0,0,0,.5);
    }

    .new-row{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    @media (max-width: 980px){
      .hero{ grid-template-columns: 1fr; }
      .hero-img{ margin:0 auto; }
      .hero-title{ text-align:center; }
      .new-row{ grid-template-columns: 1fr; }
    }

    /* controls */
    .controls{
      margin: 16px 0 10px;
      padding: 14px;
      border-radius: var(--radius);
      border:1px solid rgba(231,207,154,.18);
      background: linear-gradient(180deg, rgba(24,10,36,.65), rgba(15,7,22,.50));
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
    }

    .control-top{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }

    .search{
      flex: 1 1 320px;
      display:flex;
      gap: 10px;
      align-items:center;
    }

    .search input{
      width:100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid rgba(231,207,154,.26);
      background: rgba(0,0,0,.25);
      color: var(--ink);
      font-size: 14px;
      outline:none;
    }

    .btn{
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid rgba(231,207,154,.26);
      background: linear-gradient(180deg, rgba(58,31,92,.70), rgba(26,12,40,.78));
      color: var(--ink);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      box-shadow: 0 8px 18px rgba(0,0,0,.35);
      user-select:none;
      white-space:nowrap;
      font-size: 13px;
    }
    .btn:hover{ border-color: rgba(231,207,154,.45); }
    .btn.gold{
      background: linear-gradient(180deg, rgba(199,155,83,.90), rgba(231,207,154,.70));
      color:#1c1024;
      border-color: rgba(231,207,154,.7);
      font-weight:700;
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top: 10px;
      min-height: 20px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(231,207,154,.22);
      background: rgba(0,0,0,.22);
      color: var(--ink2);
      font-size: 12px;
    }
    .chip button{
      background: transparent;
      border:none;
      color: var(--gold2);
      cursor:pointer;
      font-size: 14px;
      line-height: 1;
      padding: 0;
    }

    /* popovers */
    .popover{
      position: relative;
      display:inline-block;
    }
    .panel{
      position:absolute;
      top: 46px;
      left: 0;
      width: min(380px, 92vw);
      border-radius: 16px;
      border: 1px solid rgba(231,207,154,.26);
      background:
        radial-gradient(600px 300px at 20% 10%, rgba(231,207,154,.12), transparent 55%),
        linear-gradient(160deg, rgba(58,31,92,.92), rgba(20,10,30,.92));
      box-shadow: var(--shadow);
      padding: 12px;
      display:none;
      z-index: 50;
    }
    .panel.open{ display:block; }

    .panel h3{
      margin: 0 0 10px;
      font-size: 13px;
      letter-spacing:.5px;
      color: var(--gold2);
      text-transform: uppercase;
    }

    .panel .mini-search{
      width:100%;
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px solid rgba(231,207,154,.22);
      background: rgba(0,0,0,.22);
      color: var(--ink);
      outline:none;
      font-size: 13px;
      margin-bottom: 10px;
    }

    .panel .list{
      max-height: 280px;
      overflow:auto;
      padding-right: 4px;
    }

    .panel label{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 7px 8px;
      border-radius: 12px;
      border: 1px solid transparent;
      cursor:pointer;
      user-select:none;
      font-size: 13px;
      color: var(--ink);
    }
    .panel label:hover{
      border-color: rgba(231,207,154,.18);
      background: rgba(0,0,0,.18);
    }
    .panel input[type="checkbox"]{ margin:0; }

    .panel .actions{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      margin-top: 10px;
    }
    .panel .actions .btn{ flex: 1; justify-content:center; }

    /* main counter */
    .counter{
      margin: 12px 2px 10px;
      color: var(--muted);
      font-size: 13px;
    }

    /* grid */
    .grid{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 14px;
    }
    @media (max-width: 1250px){ .grid{ grid-template-columns: repeat(4, 1fr); } }
    @media (max-width: 1050px){ .grid{ grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 740px){ .grid{ grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 460px){ .grid{ grid-template-columns: 1fr; } }

    /* textured card */
    .card{
      border-radius: 18px;
      border: 1px solid rgba(231,207,154,.24);
      background:
        radial-gradient(420px 220px at 50% 0%, rgba(231,207,154,.14), transparent 55%),
        linear-gradient(160deg, rgba(58,31,92,.84), rgba(20,10,30,.90));
      box-shadow: var(--shadow2);
      overflow:hidden;
      position:relative;
    }
    .card:before{
      content:"";
      position:absolute; inset:0;
      pointer-events:none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.75' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.08'/%3E%3C/svg%3E");
      opacity:.45;
      mix-blend-mode: overlay;
    }

    .cover{
      position:relative;
      aspect-ratio: 1 / 1;
      background: rgba(0,0,0,.25);
      border-bottom: 1px solid rgba(231,207,154,.16);
    }
    .cover img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
      filter: saturate(1.05) contrast(1.03);
    }
    .cover:after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(180deg, transparent 60%, rgba(0,0,0,.35));
      pointer-events:none;
    }

    /* parchment/ribbon year */
    .ribbon{
      position:absolute;
      bottom: 10px;
      left: 10px;
      padding: 6px 10px;
      font-weight: 800;
      font-size: 12px;
      color: #2a1540;
      border-radius: 10px;
      border: 1px solid rgba(103, 77, 33, .35);
      background:
        radial-gradient(120px 40px at 30% 20%, rgba(255,255,255,.35), transparent 60%),
        linear-gradient(180deg, rgba(231,207,154,.98), rgba(199,155,83,.88));
      box-shadow: 0 8px 18px rgba(0,0,0,.45);
      text-shadow: none;
    }
    .ribbon:before, .ribbon:after{
      content:"";
      position:absolute;
      top:50%;
      width: 10px; height: 10px;
      background: inherit;
      border: inherit;
      transform: translateY(-50%) rotate(45deg);
      filter: brightness(.98);
    }
    .ribbon:before{ left:-6px; }
    .ribbon:after{ right:-6px; }

    .body{
      padding: 10px 12px 12px;
      position:relative;
    }

    .title{
      font-weight: 800;
      font-size: 15.5px;
      color: var(--ink);
      letter-spacing: .25px;
      line-height: 1.15;
      margin-top: 2px;
      text-shadow: 0 2px 10px rgba(0,0,0,.35);
    }

    .artist{
      margin-top: 4px;
      font-weight: 800;
      font-size: 14.6px;
      color: var(--gold2);
      letter-spacing: .35px;
      text-shadow: 0 2px 10px rgba(0,0,0,.35);
    }

    .divider{
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--line), transparent);
      margin: 10px 0 8px;
    }

    .metaRow{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:center;
      color: var(--ink2);
      font-size: 12px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(231,207,154,.18);
      background: rgba(0,0,0,.18);
      color: var(--ink2);
      font-size: 11.5px;
      white-space:nowrap;
    }
    .pill.gold{
      border-color: rgba(231,207,154,.22);
      background: rgba(199,155,83,.14);
      color: #f5ecd4;
      font-style: italic;
    }

    .subRow{
      margin-top: 8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      color: var(--muted);
      font-size: 11.5px;
      opacity: .92;
    }

    .mini.card{
      border-radius: 16px;
    }
    .mini .cover{
      aspect-ratio: 16 / 9;
    }
    .mini .ribbon{
      bottom: 8px;
      left: 8px;
      padding: 5px 9px;
      font-size: 11px;
      border-radius: 10px;
    }
    .mini .body{
      padding: 9px 10px 10px;
    }
    .mini .title{ font-size: 13.5px; }
    .mini .artist{ font-size: 13px; }
    .mini .divider{ margin: 8px 0 6px; }
    .mini .subRow{ margin-top: 6px; }

    .newTag{
      position:absolute;
      top: 10px;
      right: 10px;
      padding: 5px 9px;
      font-size: 11px;
      font-weight: 900;
      letter-spacing: .7px;
      border-radius: 999px;
      color: #1c1024;
      background: linear-gradient(180deg, rgba(231,207,154,.98), rgba(199,155,83,.88));
      border: 1px solid rgba(231,207,154,.55);
      box-shadow: 0 10px 18px rgba(0,0,0,.35);
      text-transform: uppercase;
    }

    .hidden{ display:none !important; }
  </style>
</head>

<body>
  <div class="wrap">

    <nav class="top-nav">
      <a class="active" href="index.html">Songs</a>
      <a href="soundtracks.html">Soundtracks</a>
    </nav>

    <section class="hero">
      <div class="hero-img">
        <img src="img/header.png" alt="Cugell">
      </div>

      <div class="hero-right">
        <h1 class="hero-title">Cugell’s Songs</h1>

        <div class="new-row" id="newRow">
          <!-- filled by JS (3 newest) -->
        </div>
      </div>
    </section>

    <section class="controls">
      <div class="control-top">
        <div class="search">
          <input id="search" type="text" placeholder="Search by title, artist, year, genre…" />
        </div>

        <div class="popover" id="popDecade">
          <button class="btn" type="button" data-popbtn="decade">Decade ▾</button>
          <div class="panel" data-panel="decade">
            <h3>Decades</h3>
            <div class="list" id="decadeList"></div>
            <div class="actions">
              <button class="btn" type="button" data-action="decade-clear">Clear</button>
              <button class="btn gold" type="button" data-action="decade-close">Done</button>
            </div>
          </div>
        </div>

        <div class="popover" id="popGenre">
          <button class="btn" type="button" data-popbtn="genre">Genre ▾</button>
          <div class="panel" data-panel="genre">
            <h3>Genres</h3>
            <input class="mini-search" id="genreSearch" type="text" placeholder="Find a genre…" />
            <div class="list" id="genreList"></div>
            <div class="actions">
              <button class="btn" type="button" data-action="genre-clear">Clear</button>
              <button class="btn gold" type="button" data-action="genre-close">Done</button>
            </div>
          </div>
        </div>

        <button class="btn" type="button" id="clearAll">Clear filters</button>
      </div>

      <div class="chips" id="chips"></div>
    </section>

    <div class="counter" id="counter"></div>
    <div class="grid" id="grid"></div>
  </div>

  <!-- ===== MULTI-FILE SONG SYSTEM ===== -->
  <script src="songs/songs_0.js"></script>
  <script src="songs/songs_A.js"></script>
  <script src="songs/songs_B.js"></script>
  <script src="songs/songs_C.js"></script>
  <script src="songs/songs_D.js"></script>
  <script src="songs/songs_E.js"></script>
  <script src="songs/songs_F.js"></script>
  <script src="songs/songs_G.js"></script>
  <script src="songs/songs_H.js"></script>
  <script src="songs/songs_I.js"></script>
  <script src="songs/songs_J.js"></script>
  <script src="songs/songs_K.js"></script>
  <script src="songs/songs_L.js"></script>
  <script src="songs/songs_M.js"></script>
  <script src="songs/songs_N.js"></script>
  <script src="songs/songs_O.js"></script>
  <script src="songs/songs_P.js"></script>
  <script src="songs/songs_Q.js"></script>
  <script src="songs/songs_R.js"></script>
  <script src="songs/songs_S.js"></script>
  <script src="songs/songs_T.js"></script>
  <script src="songs/songs_U.js"></script>
  <script src="songs/songs_V.js"></script>
  <script src="songs/songs_W.js"></script>
  <script src="songs/songs_X.js"></script>
  <script src="songs/songs_Y.js"></script>
  <script src="songs/songs_Z.js"></script>

  <script>
    /* ------------------ helpers ------------------ */
    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function normArray(val) {
      if (!val) return [];
      if (Array.isArray(val)) return val;
      return String(val).split(/[\|,]/g).map(v => v.trim()).filter(Boolean);
    }

    function getAllSongs() {
      return [
        ...(typeof songs09 !== "undefined" ? songs09 : []),
        ...(typeof songsA !== "undefined" ? songsA : []),
        ...(typeof songsB !== "undefined" ? songsB : []),
        ...(typeof songsC !== "undefined" ? songsC : []),
        ...(typeof songsD !== "undefined" ? songsD : []),
        ...(typeof songsE !== "undefined" ? songsE : []),
        ...(typeof songsF !== "undefined" ? songsF : []),
        ...(typeof songsG !== "undefined" ? songsG : []),
        ...(typeof songsH !== "undefined" ? songsH : []),
        ...(typeof songsI !== "undefined" ? songsI : []),
        ...(typeof songsJ !== "undefined" ? songsJ : []),
        ...(typeof songsK !== "undefined" ? songsK : []),
        ...(typeof songsL !== "undefined" ? songsL : []),
        ...(typeof songsM !== "undefined" ? songsM : []),
        ...(typeof songsN !== "undefined" ? songsN : []),
        ...(typeof songsO !== "undefined" ? songsO : []),
        ...(typeof songsP !== "undefined" ? songsP : []),
        ...(typeof songsQ !== "undefined" ? songsQ : []),
        ...(typeof songsR !== "undefined" ? songsR : []),
        ...(typeof songsS !== "undefined" ? songsS : []),
        ...(typeof songsT !== "undefined" ? songsT : []),
        ...(typeof songsU !== "undefined" ? songsU : []),
        ...(typeof songsV !== "undefined" ? songsV : []),
        ...(typeof songsW !== "undefined" ? songsW : []),
        ...(typeof songsX !== "undefined" ? songsX : []),
        ...(typeof songsY !== "undefined" ? songsY : []),
        ...(typeof songsZ !== "undefined" ? songsZ : []),
      ];
    }

    function parseDateSafe(s){
      const t = Date.parse(s || "");
      return Number.isFinite(t) ? t : 0;
    }

    function isMeaningfulDuration(d){
      if (!d) return false;
      const v = String(d).trim();
      if (!v) return false;
      return v !== "00:00" && v !== "0:00";
    }

    /* ------------------ state ------------------ */
    const state = {
      all: [],
      decadesSelected: new Set(),
      genresSelected: new Set(),
      genreSearch: "",
    };

    const DECADES = [
      { label:"60s", value:"60s Music" },
      { label:"70s", value:"70s Music" },
      { label:"80s", value:"80s Music" },
      { label:"90s", value:"90s Music" },
      { label:"2000s", value:"2000s Music" },
      { label:"2010s", value:"2010s Music" },
      { label:"2020s", value:"2020s Music" },
      { label:"Mixed", value:"Mixed Years" },
    ];

    /* ------------------ popovers ------------------ */
    function closeAllPanels(){
      document.querySelectorAll(".panel.open").forEach(p => p.classList.remove("open"));
    }

    function togglePanel(name){
      const panel = document.querySelector(`.panel[data-panel="${name}"]`);
      if (!panel) return;
      const isOpen = panel.classList.contains("open");
      closeAllPanels();
      if (!isOpen) panel.classList.add("open");
    }

    document.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-popbtn]");
      if (btn){
        togglePanel(btn.getAttribute("data-popbtn"));
        return;
      }
      const insidePanel = e.target.closest(".panel");
      const insidePopover = e.target.closest(".popover");
      if (!insidePanel && !insidePopover){
        closeAllPanels();
      }
    });

    /* ------------------ filters UI ------------------ */
    function buildDecadeList(){
      const box = document.getElementById("decadeList");
      box.innerHTML = DECADES.map(d => `
        <label>
          <input type="checkbox" data-decade="${escapeHtml(d.value)}">
          <span>${escapeHtml(d.label)}</span>
        </label>
      `).join("");

      box.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener("change", () => {
          const val = cb.getAttribute("data-decade");
          if (cb.checked) state.decadesSelected.add(val);
          else state.decadesSelected.delete(val);
          render();
        });
      });
    }

    function buildGenreList(){
      const genres = new Set();
      state.all.forEach(s => normArray(s.style).forEach(g => genres.add(g)));

      const sorted = Array.from(genres)
        .map(x => x.trim()).filter(Boolean)
        .sort((a,b) => a.toLowerCase().localeCompare(b.toLowerCase()));

      const box = document.getElementById("genreList");
      box.innerHTML = sorted.map(g => `
        <label data-genre-row="${escapeHtml(g.toLowerCase())}">
          <input type="checkbox" data-genre="${escapeHtml(g)}">
          <span>${escapeHtml(g)}</span>
        </label>
      `).join("");

      box.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener("change", () => {
          const val = cb.getAttribute("data-genre");
          if (cb.checked) state.genresSelected.add(val);
          else state.genresSelected.delete(val);
          render();
        });
      });

      applyGenreSearchFilter();
    }

    function applyGenreSearchFilter(){
      const q = (state.genreSearch || "").trim().toLowerCase();
      document.querySelectorAll("[data-genre-row]").forEach(row => {
        const key = row.getAttribute("data-genre-row") || "";
        row.classList.toggle("hidden", q && !key.includes(q));
      });
    }

    function syncCheckboxes(){
      // decades
      document.querySelectorAll('input[data-decade]').forEach(cb => {
        const v = cb.getAttribute("data-decade");
        cb.checked = state.decadesSelected.has(v);
      });
      // genres
      document.querySelectorAll('input[data-genre]').forEach(cb => {
        const v = cb.getAttribute("data-genre");
        cb.checked = state.genresSelected.has(v);
      });
    }

    function renderChips(){
      const box = document.getElementById("chips");
      const chips = [];

      // decades chips (use labels)
      for (const d of DECADES){
        if (state.decadesSelected.has(d.value)){
          chips.push({ type:"decade", value:d.value, label:d.label });
        }
      }

      // genre chips
      Array.from(state.genresSelected).sort((a,b)=>a.toLowerCase().localeCompare(b.toLowerCase()))
        .forEach(g => chips.push({ type:"genre", value:g, label:g }));

      box.innerHTML = chips.map(c => `
        <span class="chip">
          ${escapeHtml(c.label)}
          <button type="button" aria-label="Remove">×</button>
        </span>
      `).join("");

      // bind remove
      Array.from(box.querySelectorAll(".chip")).forEach((el, idx) => {
        el.querySelector("button").addEventListener("click", () => {
          const c = chips[idx];
          if (c.type === "decade") state.decadesSelected.delete(c.value);
          else state.genresSelected.delete(c.value);
          syncCheckboxes();
          render();
        });
      });
    }

    /* ------------------ data -> view ------------------ */
    function makeCard(song, { mini=false, newTag=false } = {}){
      const cover = song.cover || "img/default-cover.jpg";
      const title = song.title || "";
      const artist = song.artist || "";
      const year = song.year || "";
      const decade = song.category || "";
      const styles = normArray(song.style);
      const duration = song.duration || "";

      const stylePills = styles.slice(0, 2).map(st => `<span class="pill gold">${escapeHtml(st)}</span>`).join("");
      const extraStyles = styles.length > 2 ? `<span class="pill">+${styles.length - 2}</span>` : "";

      const decadePill = decade ? `<span class="pill">${escapeHtml(decade)}</span>` : "";
      const yearRibbon = year ? `<div class="ribbon">${escapeHtml(year)}</div>` : "";

      const durText = isMeaningfulDuration(duration) ? `⏱ ${escapeHtml(duration)}` : "";

      return `
        <div class="card ${mini ? "mini" : ""}">
          <div class="cover">
            <img src="${escapeHtml(cover)}" alt="${escapeHtml(title)}">
            ${yearRibbon}
            ${newTag ? `<div class="newTag">NEW</div>` : ""}
          </div>
          <div class="body">
            <div class="title">${escapeHtml(title)}</div>
            <div class="artist">${escapeHtml(artist)}</div>
            <div class="divider"></div>

            <div class="metaRow">
              ${stylePills}
              ${extraStyles}
            </div>

            <div class="subRow">
              <span>${decadePill}</span>
              <span>${durText}</span>
            </div>
          </div>
        </div>
      `;
    }

    function renderNewRow(){
      const box = document.getElementById("newRow");
      const newest = state.all
        .slice()
        .sort((a,b) => parseDateSafe(b.addedAt) - parseDateSafe(a.addedAt))
        .slice(0, 3);

      // If no addedAt at all, show nothing (but keep layout)
      const anyHasDate = newest.some(s => parseDateSafe(s.addedAt) > 0);
      if (!anyHasDate){
        box.innerHTML = `
          <div class="card mini"><div class="body"><div class="title">No recent edits yet</div><div class="divider"></div><div class="metaRow"><span class="pill">Edit songs in your workflow</span></div></div></div>
          <div class="card mini"><div class="body"><div class="title">Tip</div><div class="divider"></div><div class="metaRow"><span class="pill">Use search + popover filters</span></div></div></div>
          <div class="card mini"><div class="body"><div class="title">Welcome</div><div class="divider"></div><div class="metaRow"><span class="pill">Enjoy the setlist!</span></div></div></div>
        `;
        return;
      }

      box.innerHTML = newest.map(s => makeCard(s, { mini:true, newTag:true })).join("");
    }

    function filterSongs(){
      const q = (document.getElementById("search").value || "").trim().toLowerCase();

      return state.all.filter(song => {
        const styles = normArray(song.style);

        const searchTarget = (
          (song.title || "") + " " +
          (song.artist || "") + " " +
          (song.year || "") + " " +
          (song.category || "") + " " +
          styles.join(" ")
        ).toLowerCase();

        const matchesSearch = !q || searchTarget.includes(q);

        const matchesDecade =
          state.decadesSelected.size === 0 ||
          state.decadesSelected.has(song.category);

        // AND logic: must contain all selected genres
        const matchesGenres =
          state.genresSelected.size === 0 ||
          Array.from(state.genresSelected).every(g => styles.includes(g));

        return matchesSearch && matchesDecade && matchesGenres;
      });
    }

    function renderGrid(){
      const grid = document.getElementById("grid");
      const counter = document.getElementById("counter");

      const filtered = filterSongs();
      grid.innerHTML = filtered.map(s => makeCard(s)).join("");
      counter.textContent = `${filtered.length} song(s) shown`;
    }

    function render(){
      renderChips();
      renderGrid();
    }

    /* ------------------ actions ------------------ */
    document.getElementById("search").addEventListener("input", () => render());

    document.getElementById("genreSearch").addEventListener("input", (e) => {
      state.genreSearch = e.target.value || "";
      applyGenreSearchFilter();
    });

    document.getElementById("clearAll").addEventListener("click", () => {
      state.decadesSelected.clear();
      state.genresSelected.clear();
      document.getElementById("search").value = "";
      state.genreSearch = "";
      document.getElementById("genreSearch").value = "";
      syncCheckboxes();
      applyGenreSearchFilter();
      closeAllPanels();
      render();
    });

    document.querySelectorAll("[data-action]").forEach(btn => {
      btn.addEventListener("click", () => {
        const a = btn.getAttribute("data-action");
        if (a === "decade-clear"){ state.decadesSelected.clear(); syncCheckboxes(); render(); }
        if (a === "genre-clear"){ state.genresSelected.clear(); syncCheckboxes(); render(); }
        if (a === "decade-close" || a === "genre-close"){ closeAllPanels(); }
      });
    });

    /* ------------------ init ------------------ */
    state.all = getAllSongs();
    buildDecadeList();
    buildGenreList();
    syncCheckboxes();
    renderNewRow();
    render();
  </script>
</body>
</html>
